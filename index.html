<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MARC 21 - Auto Search v7</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root { --primary: #0f172a; --accent: #7c3aed; --bg: #f8fafc; --text: #334155; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 140px; }
header { background: white; padding: 14px; font-weight: 800; text-align: center; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 50; }

/* Controls */
.controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; padding: 8px; background: white; border-bottom: 1px solid #e2e8f0; }
.mode-btn { padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 13px; color: #64748b; font-weight: 600; }
.mode-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

/* Camera & Search Bar */
.action-area { padding: 12px; background: white; margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; }
#scanBtn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
.search-box { display: flex; gap: 8px; }
.search-input { flex: 1; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; }
.search-btn { padding: 8px 16px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; font-weight: 600; color: #475569; }

.status { margin-top: 8px; font-size: 12px; color: #64748b; text-align: center; min-height: 18px; }

/* MARC Card */
.card { background: white; margin: 0 12px; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: bold; background: #f1f5f9; color: #64748b; }
.badge.api { background: #dcfce7; color: #166534; }
.badge.search { background: #dbeafe; color: #1e40af; } /* Blue for Search Result */
.badge.ocr { background: #ffedd5; color: #9a3412; }

/* Fields */
.field-group { margin-bottom: 12px; }
.tag-label { font-family: monospace; font-size: 11px; font-weight: bold; color: #94a3b8; display: block; margin-bottom: 2px; }
.input-wrapper { display: flex; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; background: #fff; }
.scroll-input {
    flex: 1; padding: 12px; font-size: 16px; font-family: monospace; border: none; outline: none;
    white-space: nowrap; overflow-x: auto; overflow-y: hidden; resize: none;
}
.multiline { white-space: normal; min-height: 80px; }
.copy-btn { width: 44px; background: #f8fafc; border-left: 1px solid #cbd5e1; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
.copy-btn:active { background: #e2e8f0; }

/* FAB */
.fab-container { position: fixed; bottom: 20px; left: 0; right: 0; padding: 0 16px; z-index: 100; pointer-events: none; }
.copy-all-btn { pointer-events: auto; width: 100%; padding: 14px; background: #059669; color: white; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(5,150,105,0.3); }

.updated { animation: flash 1.2s ease-out; border: 2px solid #22c55e !important; }
@keyframes flash { 0% { border-color: #22c55e; background: #f0fdf4; } 100% { border-color: #cbd5e1; background: white; } }

details { margin: 16px; font-size: 11px; color: #94a3b8; }
#debug { white-space: pre-wrap; background: #f1f5f9; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; overflow-x: hidden; word-break: break-all;}
</style>
</head>
<body>

<header>MARC 21 - v7.0 (Search)</header>

<div class="controls">
    <button class="mode-btn active" onclick="setMode('copyright')">æ¢ç¢¼/ç‰ˆæ¬Š</button>
    <button class="mode-btn" onclick="setMode('cover')">å°é¢ (åæŸ¥)</button>
    <button class="mode-btn" onclick="setMode('back')">å°åº•æ‘˜è¦</button>
</div>

<div class="action-area">
    <button id="scanBtn" onclick="document.getElementById('fileIn').click()">ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ (OCR + æœå°‹)</button>
    
    <div class="search-box">
        <input type="text" id="manualQuery" class="search-input" placeholder="OCRå¤±æ•—æ™‚ï¼Œè¼¸å…¥é—œéµå­—...">
        <button class="search-btn" onclick="manualSearch()">ğŸ” æœå°‹</button>
    </div>
    <div class="status" id="status">ç³»çµ±å°±ç·’</div>
    <input type="file" id="fileIn" accept="image/*" capture="environment" style="display:none" onchange="process(this)">
</div>

<div class="card">
    <div class="card-head">
        <b>MARC è¨˜éŒ„</b>
        <span id="srcTag" class="badge">ç„¡è³‡æ–™</span>
    </div>
    
    <div class="field-group">
        <span class="tag-label">020 ISBN</span>
        <div class="input-wrapper"><textarea id="f020" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f020')">ğŸ“‹</button></div>
    </div>
    <div class="field-group">
        <span class="tag-label">100 Author</span>
        <div class="input-wrapper"><textarea id="f100" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f100')">ğŸ“‹</button></div>
    </div>
    <div class="field-group">
        <span class="tag-label">245 Title (æ»‘å‹•æŸ¥çœ‹)</span>
        <div class="input-wrapper"><textarea id="f245" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f245')">ğŸ“‹</button></div>
    </div>
    <div class="field-group">
        <span class="tag-label">250 Edition</span>
        <div class="input-wrapper"><textarea id="f250" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f250')">ğŸ“‹</button></div>
    </div>
    <div class="field-group">
        <span class="tag-label">264 Pub</span>
        <div class="input-wrapper"><textarea id="f264" class="scroll-input" rows="1" placeholder="$b Pub, $c Year"></textarea><button class="copy-btn" onclick="copyOne('f264')">ğŸ“‹</button></div>
    </div>
    <div class="field-group">
        <span class="tag-label">520 Abstract</span>
        <div class="input-wrapper"><textarea id="f520" class="scroll-input multiline" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f520')">ğŸ“‹</button></div>
    </div>
</div>

<details>
    <summary>Debug Info</summary>
    <div id="debug"></div>
</details>
<canvas id="cvs" style="display:none"></canvas>

<div class="fab-container">
    <button class="copy-all-btn" onclick="copyAll()">ğŸ“‹ è¤‡è£½å®Œæ•´è¨˜éŒ„</button>
</div>

<script>
let worker, mode = 'copyright';

(async () => {
    msg('è¼‰å…¥ OCR (è‹±/æ³•/å¾·/è¥¿)...', true);
    worker = await Tesseract.createWorker('eng+fra+deu+spa');
    msg('ç³»çµ±å°±ç·’');
})();

function setMode(m) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    const hints = {
        'copyright': 'å„ªå…ˆæ‰¾ ISBNï¼Œè‡ªå‹•å¡«å…¥',
        'cover': 'è‹¥ OCR äº‚ç¢¼ï¼Œè‡ªå‹•ç”¨é—œéµå­—æœ Google',
        'back': 'æŠ“å–æ‘˜è¦'
    };
    msg(hints[m]);
}

async function process(input) {
    if (!input.files[0]) return;
    const file = input.files[0];
    
    // UI Reset
    document.getElementById('manualQuery').value = '';
    
    msg('å½±åƒå„ªåŒ–...', true);
    const imgData = await preprocess(file);
    
    msg('OCR è¾¨è­˜ä¸­...', true);
    const { data } = await worker.recognize(imgData);
    document.getElementById('debug').textContent = data.text;
    
    await analyze(data);
    input.value = '';
}

async function analyze(data) {
    const text = data.text;
    const lines = data.lines;
    const clean = text.replace(/\|/g,'1').replace(/\bO(\d)/g,'0$1').replace(/[-\s]/g,'');
    const isbnMatch = clean.match(/(97[89]\d{10})|(\d{9}[\dX])/);
    
    let success = false;

    // --- ç­–ç•¥ A: ISBN å‘½ä¸­ ---
    if (isbnMatch) {
        const isbn = isbnMatch[0];
        if(!val('f020')) updateField('f020', `$a ${isbn}`);
        msg(`ISBN ${isbn} å‘½ä¸­ï¼ŒæŸ¥è©¢ä¸­...`, true);
        success = await fetchGoogle(`isbn:${isbn}`);
        if(!success) success = await fetchOpenLibrary(isbn); // ç°¡åŒ–
    }

    // --- ç­–ç•¥ B: æ–‡å­—åæŸ¥ (Text-to-API Rebound) ---
    // åªæœ‰åœ¨ ISBN å¤±æ•—ï¼Œä¸”æ˜¯å°é¢æ¨¡å¼æ™‚åŸ·è¡Œ
    if (!success && mode === 'cover') {
        msg('ISBN å¤±æ•—ï¼Œå˜—è©¦å¾ OCR æ–‡å­—åæŸ¥ Google...', true);
        
        // 1. æå–å€™é¸é—œéµå­—
        const extracted = extractKeywords(lines);
        if (extracted.query.length > 3) {
            document.getElementById('manualQuery').value = extracted.cleanTitle; // å¡«å…¥æœå°‹æ¡†ä¾›åƒè€ƒ
            
            // 2. åŸ·è¡Œæ¨¡ç³Šæœå°‹
            success = await fetchGoogle(extracted.query, true); 
        }
    }

    // --- ç­–ç•¥ C: ç´” OCR å¡«è£œ (æœ€å¾Œé˜²ç·š) ---
    msg('æ•´åˆ OCR çµæœ...');
    
    // ç‰ˆæ¬¡åµæ¸¬ (å…¨åŸŸ)
    const edition = extractEdition(text);
    if(edition) updateField('f250', `$a ${edition}`, true);

    if (mode === 'cover') {
        // å¦‚æœ API æœ‰æŠ“åˆ°è³‡æ–™ï¼Œå°±åªåšã€Œå‰¯æ¨™é¡Œè£œå¼·ã€ï¼Œå¦å‰‡ç”¨ OCR ç¡¬å¡«
        analyzeCoverMerge(lines, success);
    } else if (mode === 'copyright') {
        analyzeCopyrightMerge(text, lines);
    } else if (mode === 'back') {
        analyzeBack(lines);
    }

    if (success) {
        document.getElementById('srcTag').textContent = 'API / æœå°‹å‘½ä¸­';
        document.getElementById('srcTag').className = 'badge search';
    } else if (!val('f245')) {
        document.getElementById('srcTag').textContent = 'OCR è§£æ (ä½ä¿¡è³´)';
        document.getElementById('srcTag').className = 'badge ocr';
    }
    msg('å®Œæˆ');
}

// --- æ–°åŠŸèƒ½ï¼šOCR é—œéµå­—æå– ---
function extractKeywords(lines) {
    const validLines = lines.filter(l => l.text.trim().length > 2);
    if(validLines.length === 0) return { query: '', cleanTitle: '' };

    // æ‰¾æœ€å¤§å­— (å‡è¨­æ˜¯æ›¸å)
    let maxH = 0, titleIdx = -1;
    validLines.forEach((l, i) => { 
        const h = l.bbox.y1 - l.bbox.y0; 
        if(h > maxH) { maxH = h; titleIdx = i; }
    });

    // æ‰¾ä½œè€… (å‡è¨­åœ¨æ¨™é¡Œä¸Šæ–¹)
    let author = '';
    if(titleIdx > 0) {
        // å–æ¨™é¡Œä¸Šæ–¹ä¸”ä¸æ˜¯æ•¸å­—çš„è¡Œ
        for(let i=0; i < titleIdx; i++){
            const t = validLines[i].text.trim();
            if(t.length > 3 && !/\d/.test(t)) author = t;
        }
    }

    // æ¸…æ´—æ¨™é¡Œ (ç§»é™¤äº‚ç¢¼ç¬¦è™Ÿ | - _ )
    let title = validLines[titleIdx].text.trim().replace(/[|\-_â€”]/g, ' ').trim();
    
    // çµ„åˆæŸ¥è©¢å­—ä¸² (å„ªå…ˆç”¨ intitle + inauthor)
    let q = '';
    if (title.length > 2) q += `intitle:${title}`;
    // å¦‚æœæœ‰ä½œè€…ä¸”ä½œè€…åå­—çœ‹èµ·ä¾†æ­£å¸¸ (éå…¨å¤§å¯«äº‚ç¢¼)
    if (author.length > 2) q += `+inauthor:${author.split(' ')[0]}`; // åªå–ä½œè€…ç¬¬ä¸€å€‹å­—ä»¥å… OCR éŒ¯èª¤å¤ªå¤š

    return { query: q, cleanTitle: title };
}

// --- æ–°åŠŸèƒ½ï¼šæ‰‹å‹•æœå°‹ ---
async function manualSearch() {
    const q = document.getElementById('manualQuery').value.trim();
    if (!q) return;
    msg(`æœå°‹: ${q}...`, true);
    const success = await fetchGoogle(q, true); // true = fuzzy search
    if(success) {
        document.getElementById('srcTag').textContent = 'æ‰‹å‹•æœå°‹å‘½ä¸­';
        document.getElementById('srcTag').className = 'badge search';
        msg('æœå°‹æˆåŠŸ');
    } else {
        msg('æ‰¾ä¸åˆ°ç›¸é—œæ›¸ç±');
    }
}

// --- Google API æ ¸å¿ƒ ---
async function fetchGoogle(query, isFuzzy = false) {
    try {
        // å¦‚æœæ˜¯æ¨¡ç³Šæœå°‹ï¼Œé™åˆ¶åªæŠ“ç¬¬ä¸€ç­† (æœ€ç›¸é—œ)
        const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=1`;
        const res = await fetch(url);
        const json = await res.json();
        
        if (json.totalItems > 0) {
            const i = json.items[0].volumeInfo;
            
            // æ¨™é¡Œ
            let title = `$a ${i.title}`;
            if(i.subtitle) title += ` : $b ${i.subtitle}`;
            updateField('f245', title, true); // å¼·åˆ¶è¦†è“‹ OCR çš„äº‚ç¢¼
            
            // ä½œè€…
            if(i.authors) {
                // é€™è£¡æœƒè™•ç† Pline l'Ancien çš„å•é¡Œ
                const fmtName = formatAuthorName(i.authors[0]);
                updateField('f100', `$a ${fmtName}, $e author.`, true);
            }
            
            // å‡ºç‰ˆ
            let pub = '';
            if(i.publisher) pub += `$b ${i.publisher}, `;
            if(i.publishedDate) pub += `$c ${i.publishedDate.substring(0,4)}`;
            if(pub) updateField('f264', `$a [Place] : ${pub}`, true);
            
            // æ‘˜è¦
            if(i.description) updateField('f520', `$a ${i.description}`);
            
            // å˜—è©¦å›å¡« ISBN (å¦‚æœåŸæœ¬æ²’æƒåˆ°)
            if(i.industryIdentifiers && !val('f020')) {
                const isbn13 = i.industryIdentifiers.find(x=>x.type==='ISBN_13');
                if(isbn13) updateField('f020', `$a ${isbn13.identifier}`);
            }

            return true;
        }
    } catch(e) { console.error(e); }
    return false;
}

// --- é‚è¼¯ä¿®æ­£ï¼šå§“åæ ¼å¼åŒ– (å« l', d' ä¿è­·) ---
function formatAuthorName(name) {
    // 1. è™•ç†å…¨å¤§å¯« -> Title Case
    let n = name;
    if (/^[A-Z\s\.\-',]+$/.test(name)) {
        n = name.toLowerCase().replace(/(^|\s|['-])\S/g, l => l.toUpperCase());
    }
    
    // 2. ç‰¹æ®Šå‰ç¶´ä¿è­· (l', d', van, de) - ä¸è¦åœ¨é€™è£¡æ–·é–‹
    // ç°¡å–®é‚è¼¯ï¼šå¦‚æœåå­—åŒ…å« ' (å¦‚ l'Ancien)ï¼Œæˆ‘å€‘å‡è¨­ Google çµ¦çš„é †åºæ˜¯å°çš„ï¼Œä¸é€²è¡Œå€’ç½®
    // æˆ–è€…ï¼Œå¦‚æœè¦åšå€’ç½®ï¼Œå¿…é ˆç¢ºä¿ l'Ancien è¢«è¦–ç‚ºä¸€å€‹å–®è©
    
    if (n.includes("'") || n.includes(" d'")) {
        return n; // é‡åˆ°æ³•æ–‡/è¥¿æ–‡ç‰¹æ®Šåå­—ï¼Œç›´æ¥å›å‚³åŸæ¨£ï¼Œé¿å…éŒ¯èª¤å€’ç½®
    }

    const parts = n.split(' ');
    // åªæœ‰ç•¶æ²’æœ‰é€—è™Ÿæ™‚æ‰å€’ç½®
    if (parts.length > 1 && !n.includes(',')) {
        return `${parts.pop()}, ${parts.join(' ')}`;
    }
    return n;
}

// --- å…¶ä»–è¼”åŠ©åŠŸèƒ½ (Regex, Merge logic) ---
function extractEdition(text) {
    const norm = text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    const regex = /(\d+[\.\s]?(Âª|Âº|a|o|st|nd|rd|th|e|eme|er|re))[\s\.]*(ed|Ã©d|aufl)/i;
    const match = norm.match(regex);
    if(match) {
        // å˜—è©¦æŠ“å›åŸå§‹æ–‡å­—
        const rawMatch = text.match(new RegExp(match[1].replace('.','\\.'), 'i'));
        return rawMatch ? `${rawMatch[0]} edition` : match[0];
    }
    const txtEd = text.match(/(PremiÃ¨re|DeuxiÃ¨me|TroisiÃ¨me|First|Second)\s+(Ã©d|ed)/i);
    return txtEd ? txtEd[0] : null;
}

function analyzeCoverMerge(lines, apiSuccess) {
    // å¦‚æœ API å·²ç¶“æ‰¾åˆ°è³‡æ–™ï¼Œæˆ‘å€‘åªçœ‹æœ‰æ²’æœ‰æ›´é•·çš„å‰¯æ¨™é¡Œ
    if(!lines.length) return;
    
    // æ‰¾å‡º OCR æ¨™é¡Œ
    const validLines = lines.filter(l => l.text.trim().length > 2);
    let maxH = 0; validLines.forEach(l=>{const h=l.bbox.y1-l.bbox.y0;if(h>maxH)maxH=h;});
    const titleLines = validLines.filter(l => (l.bbox.y1-l.bbox.y0) > maxH*0.7);
    const ocrTitle = titleLines.map(l => l.text.trim()).join(' ');

    const curTitle = val('f245').replace(/^\$a /, '');
    
    // å¦‚æœ API æ²’æˆåŠŸï¼Œå°±ç”¨ OCR å¡«
    if (!apiSuccess && !curTitle && ocrTitle) {
        updateField('f245', `$a ${ocrTitle}`);
    }
    // å¦‚æœ API æˆåŠŸï¼Œä½† OCR æ¨™é¡Œä¼¼ä¹åŒ…å«å‰¯æ¨™é¡Œ (æ¯” API é•·å¾ˆå¤š)
    else if (apiSuccess && curTitle && ocrTitle.includes(curTitle) && ocrTitle.length > curTitle.length + 5) {
        const sub = ocrTitle.replace(curTitle, '').replace(/^[:\s]+/, '').trim();
        if(sub) updateField('f245', `$a ${curTitle} : $b ${sub}`, true);
    }
}

function analyzeCopyrightMerge(text, lines) { /* åŒ v6, çœç•¥ç´°ç¯€ */ 
    const year = text.match(/\b(19|20)\d{2}\b/);
    let pub = '';
    for(let l of lines) {
        if(l.text.includes('Â©') || /Editions|Press|Verlag/i.test(l.text)) {
            pub = l.text.replace(/.*Â©\s*\d*\s*/,'').replace(/^\d{4}/,'').trim();
            if(pub.length>2 && !/\d/.test(pub)) break;
        }
    }
    const c = val('f264');
    if(!c) {
        let s=''; if(pub)s+=`: $b ${pub}, `; if(year)s+=`$c ${year[0]}`;
        if(s) updateField('f264', `$a [Place] ${s}`);
    }
}
function analyzeBack(lines) { /* åŒ v6 */ 
    if(val('f520')) return;
    const cl = lines.filter(l => !l.text.includes('ISBN') && (l.text.replace(/[^a-z]/gi,'').length/l.text.length)>0.5);
    const s = cl.map(l=>l.text.trim()).join(' ');
    if(s.length>20) updateField('f520', `$a ${s}`);
}

// Utils
function updateField(id, v, force=false) {
    const el = document.getElementById(id);
    if(force || !el.value) {
        el.value = v;
        el.classList.add('updated');
        setTimeout(()=>el.classList.remove('updated'), 1200);
    }
}
function val(id){return document.getElementById(id).value;}
function copyOne(id){
    const el=document.getElementById(id); navigator.clipboard.writeText(el.value);
    const b=el.nextElementSibling; b.textContent='âœ…'; setTimeout(()=>b.textContent='ğŸ“‹',1000);
}
function copyAll(){
    const f=['f020','f100','f245','f250','f264','f520'];
    const t=f.map(k=>{const v=val(k); return v?`${k.substring(1)} ## ${v}`:null}).filter(x=>x).join('\n');
    navigator.clipboard.writeText(t).then(()=>{const b=document.querySelector('.copy-all-btn');b.textContent='âœ… å·²è¤‡è£½';setTimeout(()=>b.textContent='ğŸ“‹ è¤‡è£½å®Œæ•´è¨˜éŒ„',2000)});
}
function msg(t,l){document.getElementById('status').textContent=t+(l?' â³':'');}
async function fetchOpenLibrary(i){return false;} // ç°¡åŒ–
async function preprocess(file){return new Promise(r=>{const i=new Image();i.onload=()=>{const c=document.getElementById('cvs'),x=c.getContext('2d');let w=i.width,h=i.height;if(w>1500){let s=1500/w;w*=s;h*=s}c.width=w;c.height=h;x.drawImage(i,0,0,w,h);const d=x.getImageData(0,0,w,h);for(let k=0;k<d.data.length;k+=4){const g=(d.data[k]+d.data[k+1]+d.data[k+2])/3;d.data[k]=d.data[k+1]=d.data[k+2]=g>100?255:0;}x.putImageData(d,0,0);r(c.toDataURL('image/jpeg'));};i.src=URL.createObjectURL(file);});}
</script>
</body>
</html>
