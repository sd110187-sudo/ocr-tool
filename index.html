<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MARC 21 - v20.0 (Multi-Ed/Bind)</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root { --primary: #1e293b; --accent: #2563eb; --bg: #f8fafc; --text: #0f172a; --success: #15803d; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 140px; }
header { background: white; padding: 14px; font-weight: 800; text-align: center; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 50; }

/* Controls */
.controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 10px; background: white; border-bottom: 1px solid #e2e8f0; }
.mode-btn { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 13px; color: #64748b; font-weight: 600; transition: all 0.2s; }
.mode-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); }

/* Action Area */
.action-area { padding: 16px; background: white; margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; }
#scanBtn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; transition: all 0.2s; }
#scanBtn:active { transform: scale(0.98); }
#scanBtn:disabled { background: #94a3b8; cursor: wait; opacity: 0.8; }
#scanBtn.error { background: #ef4444; cursor: pointer; }

.search-box { display: flex; gap: 8px; }
.search-input { flex: 1; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 15px; }
.search-btn { padding: 0 16px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; font-weight: 600; color: #475569; }
.status { margin-top: 10px; font-size: 13px; color: #64748b; text-align: center; font-weight: 500; min-height: 20px; }

/* Fields */
.card { background: white; margin: 0 12px; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: bold; background: #f1f5f9; color: #64748b; }
.badge.api { background: #dcfce7; color: #166534; }
.badge.locked { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }

.field-group { margin-bottom: 14px; }
.tag-label { font-family: monospace; font-size: 12px; font-weight: bold; color: #64748b; display: flex; justify-content: space-between; margin-bottom: 4px; }
.lock-icon { display: none; color: #2563eb; font-size: 11px; }
.is-locked .lock-icon { display: inline; }
.is-locked .input-wrapper { border-color: #93c5fd; background: #eff6ff; }
.updated .input-wrapper { border-color: #22c55e; background: #f0fdf4; animation: flash 1s; }

.input-wrapper { display: flex; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; background: #fff; }
.scroll-input {
    flex: 1; padding: 12px; font-size: 16px; font-family: monospace; border: none; outline: none;
    white-space: nowrap; overflow-x: auto; overflow-y: hidden; resize: none; color: #334155;
}
.multiline { white-space: normal; min-height: 80px; line-height: 1.5; }
.copy-btn { width: 48px; background: #f8fafc; border-left: 1px solid #cbd5e1; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
.copy-btn:active { background: #e2e8f0; }

.spinner { width: 18px; height: 18px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes flash { 0% { background: #dcfce7; } 100% { background: #f0fdf4; } }

details { margin: 16px; font-size: 12px; color: #94a3b8; }
#debug { white-space: pre-wrap; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 150px; overflow-y: auto; overflow-x: hidden; word-break: break-all;}
.fab-container { position: fixed; bottom: 20px; left: 0; right: 0; padding: 0 16px; z-index: 100; pointer-events: none; }
.copy-all-btn { pointer-events: auto; width: 100%; padding: 16px; background: #059669; color: white; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(5,150,105,0.3); display: flex; align-items: center; justify-content: center; gap: 8px; }
</style>
</head>
<body>

<header>MARC 21 - v20.0</header>

<div class="controls">
    <button class="mode-btn active" onclick="setMode('copyright')">ç‰ˆæ¬Šé </button>
    <button class="mode-btn" onclick="setMode('cover')">å°é¢/æ‰‰é </button>
    <button class="mode-btn" onclick="setMode('back')">å°åº•æ‘˜è¦</button>
</div>

<div class="action-area">
    <button id="scanBtn" onclick="handleScanBtn()" disabled>
        <div class="spinner" id="btnSpinner"></div>
        <span id="btnText">â³ å¼•æ“è¼‰å…¥ä¸­...</span>
    </button>
    <div class="search-box">
        <input type="text" id="manualQuery" class="search-input" placeholder="æ‰‹å‹•æœå°‹...">
        <button class="search-btn" onclick="manualSearch()">ğŸ”</button>
    </div>
    <div class="status" id="status">ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™...</div>
    <input type="file" id="fileIn" accept="image/*" capture="environment" style="display:none" onchange="process(this)">
</div>

<div class="card">
    <div class="card-head"><b>MARC è¨˜éŒ„</b><span id="srcTag" class="badge">ç„¡è³‡æ–™</span></div>
    <div class="field-group" id="g020"><span class="tag-label">020 ISBN</span><div class="input-wrapper"><textarea id="f020" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f020')">ğŸ“‹</button></div></div>
    <div class="field-group" id="g100"><span class="tag-label">100 Author <span class="lock-icon">ğŸ”’</span></span><div class="input-wrapper"><textarea id="f100" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f100')">ğŸ“‹</button></div></div>
    <div class="field-group" id="g245"><span class="tag-label">245 Title <span class="lock-icon">ğŸ”’</span></span><div class="input-wrapper"><textarea id="f245" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f245')">ğŸ“‹</button></div></div>
    <div class="field-group"><span class="tag-label">250 Edition (è‡ªå‹•è­˜åˆ¥ç‰ˆæœ¬)</span><div class="input-wrapper"><textarea id="f250" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f250')">ğŸ“‹</button></div></div>
    <div class="field-group" id="g264"><span class="tag-label">264 Pub</span><div class="input-wrapper" id="wrap264"><textarea id="f264" class="scroll-input" rows="1" placeholder="$a [Place] : $b Pub, $c Year"></textarea><button class="copy-btn" onclick="copyOne('f264')">ğŸ“‹</button></div></div>
    <div class="field-group" id="g700"><span class="tag-label">700 Added Entry</span><div class="input-wrapper"><textarea id="f700" class="scroll-input" rows="1" placeholder="$a Name, $e role."></textarea><button class="copy-btn" onclick="copyOne('f700')">ğŸ“‹</button></div></div>
    <div class="field-group"><span class="tag-label">520 Abstract</span><div class="input-wrapper"><textarea id="f520" class="scroll-input multiline" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f520')">ğŸ“‹</button></div></div>
</div>

<details><summary>Debug</summary><div id="debug"></div></details>
<canvas id="cvs" style="display:none"></canvas>
<div class="fab-container"><button class="copy-all-btn" onclick="copyAll()">ğŸ“‹ è¤‡è£½å®Œæ•´è¨˜éŒ„</button></div>

<script>
let worker = null;
let mode = 'copyright';
let isIsbnLocked = false; 
let isEngineReady = false;

// 1. è£è¨‚è¡“èªå­—å…¸ (å«äº”åœ‹èªè¨€è®Šç•°é«”)
const BINDING_TERMS = {
    pbk: [
        'paperback', 'pbk', 'softcover', 'softback', 'flexibound', // è‹±
        'brochÃ©', 'broche', 'poche', 'Ã©dition de poche', // æ³•
        'taschenbuch', 'kartoniert', 'broschiert', // å¾·
        'rÃºstica', 'rustica', 'ediciÃ³n de bolsillo', 'tapa blanda', // è¥¿
        'Ğ¼ÑĞ³ĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ¾Ğ¶ĞºĞ°', 'Ğ¼ÑĞ³ĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµĞ¿Ğ»ĞµÑ‚', 'ĞºĞ°Ñ€Ğ¼Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¸Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ' // ä¿„
    ],
    hbk: [
        'hardback', 'hbk', 'hardcover', 'cased', // è‹±
        'reliÃ©', 'relie', 'cartonnÃ©', 'cartonne', // æ³•
        'gebunden', 'gebundene', 'fester einband', // å¾·
        'tapa dura', 'cartonÃ©', 'encuadernado', // è¥¿
        'Ñ‚Ğ²Ñ‘Ñ€Ğ´Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµĞ¿Ğ»Ñ‘Ñ‚', 'Ñ‚Ğ²ĞµÑ€Ğ´Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµĞ¿Ğ»ĞµÑ‚', 'Ğ² Ğ¿ĞµÑ€ĞµĞ¿Ğ»ĞµÑ‚Ğµ' // ä¿„
    ]
};

// 2. ç‰ˆæœ¬ (Edition) è¡“èª Regex (ç”¨æ–¼ 250 æ¬„ä½èˆ‡è£è¨‚è¼”åŠ©åˆ¤æ–·)
const EDITION_REGEX = /((\d+[\.\s]?(Âª|Âº|a|o|st|nd|rd|th|e|eme|er|re|ie|te|ten|de|da)\s+)|(first|second|third|fourth|fifth|sixth|seventh|eighth|ninth|tenth|premiÃ¨re|deuxiÃ¨me|troisiÃ¨me|erste|zweite|dritte|vierte|fÃ¼nfte|primera|segunda|tercera|cuarta|quinta|Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ|Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğµ|Ñ‚Ñ€ĞµÑ‚ÑŒĞµ)\s+)?(ed\.|edition|Ã©dition|edition|aufl\.|auflage|ediciÃ³n|edicion|Ğ¸Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ|Ğ¸Ğ·Ğ´\.|Ğ²Ñ‹Ğ¿ÑƒÑĞº|Ğ²Ñ‹Ğ¿\.)(\s+(rev\.|revised|revisada|augmentÃ©e|erweiterte|Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğµ|Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ğ¾Ğµ))?/i;

// 3. è§’è‰²å­—å…¸ (å«ç°¡å¯«èˆ‡è®Šç•°)
const ROLE_DICT = [
    // ç·¨è¼¯ (Editor)
    { regex: /(edited\s+by|editor|ed\.|Ã©ditÃ©\s+par|sous\s+la\s+dir\.|Ã©d\.|herausgegeben\s+von|hrsg\.|editado\s+por|ed\.|Ğ¿Ğ¾Ğ´\s+Ñ€ĞµĞ´Ğ°ĞºÑ†Ğ¸ĞµĞ¹|Ñ€ĞµĞ´\.)/i, relator: 'editor.', label: 'edited by' },
    // ç¿»è­¯ (Translator)
    { regex: /(translated\s+by|translator|trans\.|tr\.|traduit\s+par|trad\.|Ã¼bersetzt\s+von|Ã¼bers\.|traducido\s+por|trad\.|Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´|Ğ¿ĞµÑ€\.)/i, relator: 'translator.', label: 'translated by' },
    // æ’ç•« (Illustrator)
    { regex: /(illustrated\s+by|illustrator|illus\.|ill\.|illustrÃ©\s+par|illustriert\s+von|ilustrado\s+por|Ğ¸Ğ»Ğ»ÑÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸|Ğ¸Ğ»Ğ»\.)/i, relator: 'illustrator.', label: 'illustrated by' },
    // åºè¨€ (Preface/Foreword)
    { regex: /(preface\s+by|foreword\s+by|prÃ©face\s+de|avant-propos|vorwort\s+von|prefacio\s+de|prÃ³logo\s+de|Ğ¿Ñ€ĞµĞ´Ğ¸ÑĞ»Ğ¾Ğ²Ğ¸Ğµ)/i, relator: 'writer of preface.', label: 'preface by' }
];

// å‡ºç‰ˆç¤¾èˆ‡åœ°é»åº« (æ¨™æº–)
const PUB_MAP = {'ALA':'Chicago','MIT':'Cambridge','Harvard':'Cambridge','Princeton':'Princeton','Yale':'New Haven','Stanford':'Stanford','California':'Berkeley','Chicago':'Chicago','Columbia':'New York','Sage':'Thousand Oaks','Wiley':'Hoboken','Routledge':'London','CRC':'Boca Raton','Taylor':'London','McGraw-Hill':'New York','Pearson':'London','Cengage':'Boston','O\'Reilly':'Sebastopol','HarperCollins':'New York','Simon & Schuster':'New York','Random House':'New York','Penguin':'London','Macmillan':'London','Springer':'Berlin','Elsevier':'Amsterdam','Oxford':'Oxford','Cambridge':'Cambridge','Bloomsbury':'London','Gallimard':'Paris','Seuil':'Paris','Flammarion':'Paris','Hachette':'Paris','Larousse':'Paris','Dunod':'Paris','Eyrolles':'Paris','Dalloz':'Paris','Beck':'MÃ¼nchen','De Gruyter':'Berlin','Nomos':'Baden-Baden','Eksmo':'Moskva','AST':'Moskva','Litres':'Moskva','Nauka':'Moskva'};
const DB_CITIES = ['Paris','London','New York','Berlin','MÃ¼nchen','Frankfurt','Wien','Madrid','Barcelona','Roma','Milano','Bruxelles','Amsterdam','Taipei','Tokyo','Beijing','Shanghai','Hong Kong','Singapore','Sydney','Toronto','Chicago','Boston','Moskva','ĞœĞ¾ÑĞºĞ²Ğ°','St. Petersburg','Ğ¡Ğ°Ğ½ĞºÑ‚-ĞŸĞµÑ‚ĞµÑ€Ğ±ÑƒÑ€Ğ³','Boca Raton','Cambridge','Oxford','Hoboken','Berkeley','New Haven'];
const DB_PUBS = Object.keys(PUB_MAP).concat(['Press','University','Verlag','Editions','Librairie','Publishing','Books','Media','Ğ˜Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ¾']);

// è‡ªå‹•å•Ÿå‹•
window.addEventListener('DOMContentLoaded', initEngine);

async function initEngine() {
    const btn = document.getElementById('scanBtn');
    const spinner = document.getElementById('btnSpinner');
    const txt = document.getElementById('btnText');
    const status = document.getElementById('status');

    try {
        if(!worker) {
            status.textContent = "æ­£åœ¨ä¸‹è¼‰å¤šèªè¨€ OCR æ ¸å¿ƒ...";
            worker = await Tesseract.createWorker('eng+fra+deu+spa+rus');
        }
        isEngineReady = true;
        btn.disabled = false;
        btn.classList.remove('error');
        spinner.style.display = 'none';
        txt.textContent = 'ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ';
        status.textContent = "ç³»çµ±å°±ç·’ã€‚è«‹å…ˆæ‹ç‰ˆæ¬Šé ã€‚";
    } catch(e) {
        console.error(e);
        isEngineReady = false;
        btn.disabled = false;
        btn.classList.add('error');
        spinner.style.display = 'none';
        txt.textContent = 'âš ï¸ è¼‰å…¥å¤±æ•— (é»æ­¤é‡è©¦)';
        status.textContent = "éŒ¯èª¤: è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé»æ“ŠæŒ‰éˆ•é‡è©¦";
    }
}

function handleScanBtn() {
    if (!isEngineReady) {
        document.getElementById('scanBtn').disabled = true;
        document.getElementById('btnText').textContent = 'é‡è©¦ä¸­...';
        document.getElementById('btnSpinner').style.display = 'inline-block';
        initEngine();
    } else {
        document.getElementById('fileIn').click();
    }
}

function setMode(m) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    msg(m==='copyright' ? 'ç‰ˆæ¬Šé ï¼šåˆ¤æ–·ç‰ˆæœ¬èˆ‡è£è¨‚' : 'å°é¢ï¼šè£œå……è²¬ä»»è€…è³‡è¨Š');
}

async function process(input) {
    if (!input.files[0]) return;
    const file = input.files[0];
    const btn = document.getElementById('scanBtn');
    const oldTxt = document.getElementById('btnText').textContent;
    btn.disabled = true; document.getElementById('btnText').textContent = 'è™•ç†ä¸­...';
    try {
        msg('å½±åƒè™•ç†...', true); const imgData = await preprocess(file);
        msg('OCR è¾¨è­˜...', true); const { data } = await worker.recognize(imgData);
        document.getElementById('debug').textContent = data.text;
        await analyze(data);
    } catch(e) { msg('éŒ¯èª¤: ' + e.message); } finally { input.value = ''; btn.disabled = false; document.getElementById('btnText').textContent = oldTxt; }
}

async function analyze(data) {
    const text = data.text;
    const lines = data.lines;
    
    // æ™ºæ…§ ISBN é¸æ“‡
    const isbnMatch = extractSmartISBN(text);
    const existingYear = extractYear(val('f264'));
    let success = false;

    if (isbnMatch) {
        msg(`ISBN ${isbnMatch} å‘½ä¸­`, true);
        success = await fetchGoogle(`isbn:${isbnMatch}`, existingYear, null);
        if(!success) success = await fetchOpenLibrary(isbnMatch);
        if(success) lockIsbnFields();
    }

    if (!success && mode === 'cover' && !isIsbnLocked) {
        const extracted = extractKeywords(lines);
        if (extracted.query.length > 3) {
            msg(`åæŸ¥: ${extracted.cleanTitle}...`, true);
            success = await fetchGoogle(extracted.query, existingYear, extracted.cleanTitle); 
        }
    }

    msg('OCR è³‡æ–™æ•´åˆ...');

    if (mode !== 'back') {
        const edition = extractEdition(text);
        if(edition) updateField('f250', `$a ${edition}`, true);
        
        detectAndFixRoles(lines);
        detectPublisherAndPlace(lines, text);
        
        if (mode === 'cover') detectResponsibility(lines); 
    }

    if (mode === 'back') analyzeBack(lines);
    else if (mode === 'cover') analyzeCoverMerge(lines, success); 
    else if (mode === 'copyright') {
        const year = extractYear(text);
        if (year && !val('f264').includes(year)) {
            let current = val('f264') || '';
            if(!current.includes('$c')) updateField('f264', `${current} $c ${year}`, true);
        }
    }

    if (!success && !val('f245') && !isIsbnLocked) {
        document.getElementById('srcTag').textContent = 'OCR è§£æ';
        document.getElementById('srcTag').className = 'badge ocr';
    }
    msg('å®Œæˆ');
}

// --- æ ¸å¿ƒå‡ç´šï¼šäº”åœ‹èªè¨€æ™ºæ…§ ISBN é¸æ“‡å™¨ ---
function extractSmartISBN(text) {
    const allIsbns = text.match(/(97[89][- ]?[\d- ]{10,})/g);
    if (!allIsbns) return null;
    const cleanIsbns = allIsbns.map(i => i.replace(/[- ]/g, ''));
    if (cleanIsbns.length === 1) return cleanIsbns[0];

    const lowerText = text.toLowerCase();
    
    // åµæ¸¬é é¢æƒ…å¢ƒ (Context)
    let pageContext = null;
    if (BINDING_TERMS.pbk.some(t => lowerText.includes(t))) pageContext = 'pbk';
    else if (BINDING_TERMS.hbk.some(t => lowerText.includes(t))) pageContext = 'hbk';

    const lines = text.split('\n');
    let bestIsbn = cleanIsbns[0]; 

    for (let line of lines) {
        const lineIsbnMatch = line.match(/(97[89][- ]?[\d- ]{10,})/);
        if (lineIsbnMatch) {
            const cleanLineIsbn = lineIsbnMatch[0].replace(/[- ]/g, '');
            const lineLower = line.toLowerCase();
            
            // å„ªå…ˆåŒ¹é…é é¢æƒ…å¢ƒ
            if (pageContext === 'pbk' && BINDING_TERMS.pbk.some(t => lineLower.includes(t))) return cleanLineIsbn;
            if (pageContext === 'hbk' && BINDING_TERMS.hbk.some(t => lineLower.includes(t))) return cleanLineIsbn;
            
            // Fallback: å¦‚æœè¡Œå…§æœ‰å¹³è£é—œéµå­—ï¼Œå„ªå…ˆé¸æ“‡ (é€šå¸¸å¹³è£è¼ƒæµé€š)
            if (!pageContext && BINDING_TERMS.pbk.some(t => lineLower.includes(t))) bestIsbn = cleanLineIsbn;
        }
    }
    return bestIsbn;
}

// --- æ ¸å¿ƒå‡ç´šï¼šäº”åœ‹èªè¨€ 250 ç‰ˆæ¬¡æå– ---
function extractEdition(text) {
    // å…ˆå°æ–‡å­—é€²è¡Œç°¡å–®çš„æ­£è¦åŒ– (ç§»é™¤é‡éŸ³ç¬¦è™Ÿæ–¹ä¾¿æ¯”å°ï¼Œä½†ä¿ç•™åŸå§‹æ–‡å­—ç”¨æ–¼æå–)
    // é€™è£¡æˆ‘å€‘ç›´æ¥ç”¨ Regex (Flag i) é€²è¡Œæ¯”å°
    const match = text.match(EDITION_REGEX);
    if (match) {
        // æŠ“å–åˆ°çš„å¯èƒ½æ˜¯è·¨è¡Œæˆ–æœ‰é›œè¨Šï¼Œé€™è£¡åšç°¡å–®æ¸…æ´—
        return match[0].trim().replace(/\s+/g, ' '); 
    }
    return null;
}

// --- è§’è‰²äº’æ›èˆ‡æ¨™æº–åŒ– ($c) ---
function detectAndFixRoles(lines) {
    const validLines = lines.filter(l => l.text.trim().length > 2);
    const current100 = val('f100');
    let new700 = val('f700') || '';
    let responsibilityStatements = [];

    for (let i = 0; i < validLines.length; i++) {
        const lineText = validLines[i].text.trim();
        for (let roleDef of ROLE_DICT) {
            const match = lineText.match(roleDef.regex);
            if (match) {
                let extractedName = lineText.replace(match[0], '').replace(/by|par|von|de|por|Ğ¿Ğ¾Ğ´|Ğ¾Ñ‚/i, '').trim();
                if (extractedName.length < 3 && validLines[i+1]) extractedName = validLines[i+1].text.trim();
                extractedName = extractedName.replace(/^[:\-\.]+/g, '').trim();

                if (extractedName.length > 3 && !/\d/.test(extractedName)) {
                    // A. ä¿®æ­£ 100
                    const nameParts = extractedName.split(' ');
                    const lastName = nameParts[nameParts.length - 1].replace(/,/g,'');
                    if (current100 && current100.includes(lastName)) {
                        updateField('f100', '', true);
                    }

                    // B. å¡«å…¥ 700
                    const fmtName = formatAuthorName(extractedName);
                    const entry = `$a ${fmtName}, $e ${roleDef.relator}`;
                    if (!new700.includes(fmtName)) {
                        new700 = new700 ? `${new700}   ${entry}` : entry;
                        updateField('f700', new700, true);
                    }

                    // C. æ”¶é›† 245 $c (æ¨™æº–åŒ–æ¨™ç±¤)
                    const normalizedStmt = `${roleDef.label} ${extractedName}`;
                    if (!responsibilityStatements.includes(normalizedStmt)) {
                        responsibilityStatements.push(normalizedStmt);
                    }
                }
            }
        }
    }

    if (responsibilityStatements.length > 0) {
        const cur245 = val('f245');
        const fullStmt = responsibilityStatements.join(' ; ');
        if (cur245 && !cur245.includes('$c')) {
            updateField('f245', `${cur245} / $c ${fullStmt}`, true);
        }
    }
}

// åš´æ ¼å¥å¼å°å¯«
const PROPER_NOUNS = ['Python','Java','Linux','Windows','HTML','CSS','SQL','AWS','Google','Microsoft','Apple','Amazon','China','USA','UK','Europe','Russia','France','Germany','Japan','Shakespeare','Tolstoy','I','II','III'];
function toSentenceCase(str) {
    if (!str) return str;
    let s = str.toLowerCase();
    s = s.charAt(0).toUpperCase() + s.slice(1);
    PROPER_NOUNS.forEach(noun => { const regex = new RegExp(`\\b${noun}\\b`, 'gi'); s = s.replace(regex, noun); });
    return s;
}

function detectPublisherAndPlace(lines, fullText) {
    let foundPlace = '', foundPub = '';
    const validLines = lines.filter(l => l.text.trim().length > 3);
    
    for (let line of validLines) {
        const txt = line.text.trim();
        if (!foundPlace) {
            for (let city of DB_CITIES) { if (new RegExp(`\\b${city}\\b`, 'i').test(txt)) { foundPlace = city; break; } }
        }
        const hasPubKw = DB_PUBS.some(kw => new RegExp(`\\b${kw}\\b`, 'i').test(txt));
        const hasCopy = txt.includes('Â©') || txt.includes('Copyright');
        if (hasPubKw || hasCopy) {
            let cleanPub = txt.replace(/Â©\s*\d{4}/, '').replace(/Copyright/i, '').trim();
            if (!foundPub && !/^[\d\s]+$/.test(cleanPub)) foundPub = cleanPub;
        }
    }
    
    if (!foundPlace && (foundPub || val('f264'))) {
        const p = foundPub || val('f264');
        for (let [k, v] of Object.entries(PUB_MAP)) { if (p.toLowerCase().includes(k.toLowerCase())) { foundPlace = v; break; } }
    }

    const current264 = val('f264'); let new264 = current264;
    if (!current264.includes('$a') && foundPlace) { if (!new264) new264 = `$a ${foundPlace} :`; else new264 = `$a ${foundPlace} : ` + new264.replace('$a [Place] :', ''); } else if (current264.includes('[Place]') && foundPlace) new264 = new264.replace('[Place]', foundPlace);
    if ((!current264.includes('$b') || current264.includes('Auerbach')) && foundPub) { 
        let pubStr = `: $b ${foundPub},`;
        if (current264.includes('$b')) new264 = new264.replace(/: \$b [^,]+,/, pubStr);
        else if (new264.includes(':')) new264 = new264.replace(':', pubStr); 
        else new264 += ` ${pubStr}`; 
    }
    if (new264 !== current264) updateField('f264', new264, true);
}

// Google API
async function fetchGoogle(q,y,v){if(isIsbnLocked&&!q.startsWith('isbn:'))return false;try{const r=await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=5`);const j=await r.json();if(j.totalItems>0){let b=j.items[0];if(v){const s=checkSimilarity(v,b.volumeInfo.title||"");if(s<0.3)return false}if(y){const yi=parseInt(y);const m=j.items.find(x=>{const iy=parseInt(extractYear(x.volumeInfo.publishedDate||''));return!isNaN(iy)&&Math.abs(iy-yi)<=2});if(m)b=m}const i=b.volumeInfo;if(!isIsbnLocked){let t=`$a ${toSentenceCase(i.title)}`;if(i.subtitle)t+=` : $b ${toSentenceCase(i.subtitle)}`;updateField('f245',t,true);if(i.authors)updateField('f100',`$a ${formatAuthorName(i.authors[0])}, $e author.`,true)}const ay=extractYear(i.publishedDate||'');const yd=y&&ay?Math.abs(parseInt(y)-parseInt(ay)):0;if(!y||yd<=3){let p='';if(i.publisher)p+=`$b ${i.publisher}, `;if(i.publishedDate)p+=`$c ${i.publishedDate.substring(0,4)}`;if(p)updateField('f264',`$a [Place] : ${p}`,true)}if(i.description&&val('f520').length<50)updateField('f520',`$a ${i.description}`);if(i.industryIdentifiers&&!val('f020')){const n=i.industryIdentifiers.find(x=>x.type==='ISBN_13');if(n)updateField('f020',`$a ${n.identifier}`)}if(!isIsbnLocked){document.getElementById('srcTag').textContent='API å‘½ä¸­';document.getElementById('srcTag').className='badge api'}return true}}catch(e){}return false}

// Utils
function lockIsbnFields() { isIsbnLocked = true; document.getElementById('g100').classList.add('is-locked'); document.getElementById('g245').classList.add('is-locked'); document.getElementById('srcTag').textContent='ISBN é–å®š'; document.getElementById('srcTag').className='badge locked'; }
function analyzeCoverMerge(l,s){if(!l.length)return;const v=l.filter(x=>x.text.trim().length>2);let m=0;v.forEach(x=>{const h=x.bbox.y1-x.bbox.y0;if(h>m)m=h});const t=v.filter(x=>(x.bbox.y1-x.bbox.y0)>m*0.7).map(x=>x.text.trim()).join(' ');const c=val('f245').replace(/^\$a /,'');if(isIsbnLocked){if(c&&t.includes(c)&&t.length>c.length+5){const sub=t.replace(c,'').replace(/^[:\s\-\.]+/,'').trim();if(sub&&!c.includes(sub))updateField('f245',`$a ${c} : $b ${toSentenceCase(sub)}`,true)}return}if(!s&&!c&&t)updateField('f245',`$a ${toSentenceCase(t)}`);else if(c&&t.includes(c)&&t.length>c.length+5){const sub=t.replace(c,'').replace(/^[:\s\-\.]+/,'').trim();if(sub)updateField('f245',`$a ${c} : $b ${toSentenceCase(sub)}`,true)}}
function checkSimilarity(s1,s2){if(!s1||!s2)return 0;const t=s=>s.toLowerCase().replace(/[^\w\s]/g,'').split(/\s+/).filter(w=>w.length>2);const a=new Set(t(s1)),b=new Set(t(s2));let i=0;a.forEach(w=>{if(b.has(w))i++});const m=Math.min(a.size,b.size);return m===0?0:i/m}
function extractKeywords(l){const v=l.filter(x=>x.text.trim().length>2);if(!v.length)return{query:'',cleanTitle:''};let m=0,idx=-1;v.forEach((x,i)=>{const h=x.bbox.y1-x.bbox.y0;if(h>m){m=h;idx=i}});let q='',t='';if(idx>=0){t=v[idx].text.trim().replace(/[|\-_â€”]/g,' ').trim();q=`intitle:${t}`;for(let i=0;i<idx;i++){const x=v[i].text.trim();if(x.length>3&&!/\d/.test(x)&&!x.includes('Pline')){q+=`+inauthor:${x.split(' ')[0]}`;break}}}return{query:q,cleanTitle:t}}
function manualSearch(){const q=document.getElementById('manualQuery').value.trim();if(q)fetchGoogle(q,extractYear(val('f264')),null)}
function extractYear(s){const m=s?s.match(/\b(18|19|20)\d{2}\b/):null;return m?m[0]:null}
function formatAuthorName(n){if(n.includes("'")||n.includes(" d'"))return n;let x=n;if(/^[A-Z\s\.\-',]+$/.test(n))x=n.toLowerCase().replace(/(^|\s)\S/g,l=>l.toUpperCase());const p=x.split(' ');return p.length>1&&!x.includes(',')?`${p.pop()}, ${p.join(' ')}`:x}
function detectResponsibility(lines){const validLines=lines.filter(l=>l.text.trim().length>2);let maxH=0,titleIdx=-1;validLines.forEach((l,i)=>{const h=l.bbox.y1-l.bbox.y0;if(h>maxH){maxH=h;titleIdx=i}});let statement=[];if(titleIdx>=0){const titleBottomY=validLines[titleIdx].bbox.y1;for(let i=0;i<validLines.length;i++){const line=validLines[i];if(line.bbox.y0>titleBottomY){const t=line.text.trim();if(/^(par|by|von|textes|trad|edit|pref|intro|prÃ©sentÃ©s|choisis|translated|edited|foreword)/i.test(t)||t.includes('UniversitÃ©')||t.includes('Sorbonne')||t.includes('Professor'))statement.push(t)}}}if(statement.length>0){const st=statement.join(' ');const cur=val('f245');if(cur&&!cur.includes('$c'))updateField('f245',`${cur} / $c ${st}`,true)}}
function analyzeBack(l){if(val('f520'))return;const c=l.filter(x=>!x.text.includes('ISBN')&&(x.text.replace(/[^a-z]/gi,'').length/x.text.length)>0.7);const s=c.map(x=>x.text.trim()).join(' ');if(s.length>30)updateField('f520',`$a ${s}`,true)}
function updateField(id,v,f=false){const e=document.getElementById(id);if(f||!e.value){e.value=v;e.parentElement.classList.add('updated');setTimeout(()=>e.parentElement.classList.remove('updated'),1200)}}
function val(id){return document.getElementById(id).value}
function copyOne(id){const e=document.getElementById(id);navigator.clipboard.writeText(e.value);const b=e.nextElementSibling;b.textContent='âœ…';setTimeout(()=>b.textContent='ğŸ“‹',1000)}
function copyAll(){const f=['f020','f100','f245','f250','f264','f520','f700'];const t=f.map(k=>{const v=val(k);return v?`${k.substring(1)} ## ${v}`:null}).filter(x=>x).join('\n');navigator.clipboard.writeText(t).then(()=>{const b=document.querySelector('.copy-all-btn');b.textContent='âœ… å·²è¤‡è£½';setTimeout(()=>b.textContent='ğŸ“‹ è¤‡è£½å®Œæ•´è¨˜éŒ„',2000)})}
function msg(t,l){document.getElementById('status').textContent=t+(l?' â³':'')}
async function fetchOpenLibrary(i){return false}
async function preprocess(f){return new Promise(r=>{const i=new Image();i.onload=()=>{const c=document.getElementById('cvs'),x=c.getContext('2d');let w=i.width,h=i.height;if(w>1500){let s=1500/w;w*=s;h*=s}c.width=w;c.height=h;x.drawImage(i,0,0,w,h);const d=x.getImageData(0,0,w,h);for(let k=0;k<d.data.length;k+=4){const g=(d.data[k]+d.data[k+1]+d.data[k+2])/3;d.data[k]=d.data[k+1]=d.data[k+2]=g>100?255:0}x.putImageData(d,0,0);r(c.toDataURL('image/jpeg'))};i.src=URL.createObjectURL(f)})}
</script>
</body>
</html>
