<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>TKU Western Cataloger v69</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.5/tesseract.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.marc-field{font-family:Courier New,monospace;border:2px solid #e5e7eb;padding:8px;border-radius:10px}
.conf-high{background:#f0fdf4;border-color:#22c55e}
.conf-mid{background:#fefce8;border-color:#eab308}
.conf-low{background:#fef2f2;border-color:#ef4444}
.locked{outline:3px solid #22c55e}
#video-container{display:none;position:relative;border-radius:24px;overflow:hidden}
#scanner-line{position:absolute;top:0;width:100%;height:3px;background:#3b82f6;animation:scan 2s linear infinite}
@keyframes scan{0%{top:5%}50%{top:95%}100%{top:5%}}
</style>
</head>

<body class="bg-slate-50">

<div class="max-w-2xl mx-auto p-4 space-y-4">

<header class="text-center">
<h1 class="text-2xl font-black">Western MARC v69</h1>
<p class="text-xs text-slate-400">Fast OCR Â· Authority Â· Export</p>
</header>

<div class="grid grid-cols-3 gap-2">
<button onclick="setMode('cover')" class="bg-blue-600 text-white py-3 rounded-xl">ğŸ“• å°é¢</button>
<button onclick="setMode('verso')" class="bg-slate-600 text-white py-3 rounded-xl">ğŸ“„ ç‰ˆæ¬Šé </button>
<button onclick="setMode('back')"  class="bg-emerald-600 text-white py-3 rounded-xl">ğŸ“˜ å°åº•</button>
</div>

<div id="status" class="text-center text-xs text-slate-500">Initializingâ€¦</div>

<div id="video-container" class="aspect-[4/5] bg-black">
<video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
<div id="scanner-line"></div>
</div>

<div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
<div id="ocr-bar" class="bg-blue-600 h-2 w-0"></div>
</div>

<button onclick="scanPage()" class="w-full bg-black text-white py-5 rounded-2xl font-black">
SCAN PAGE
</button>

<div class="bg-white rounded-3xl shadow p-6 space-y-2">
<div>020<div id="f-020" class="marc-field">$a </div></div>
<div>100<div id="f-100" class="marc-field">$a </div></div>
<div>245<div id="f-245" class="marc-field">$a  : $b  / $c </div></div>
<div>250<div id="f-250" class="marc-field">$a </div></div>
<div>264<div id="f-264" class="marc-field">$a  : $b , $c </div></div>
<div>700<div id="f-700" class="marc-field">$a </div></div>
<div>520<div id="f-520" class="marc-field text-xs">$a </div></div>
</div>

<div class="flex gap-2">
<button onclick="copyMARC()" class="flex-1 bg-slate-800 text-white py-3 rounded-xl font-bold text-sm">COPY</button>
<button onclick="exportMRC()" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm">EXPORT .MRC</button>
</div>

</div>

<canvas id="canvas" class="hidden"></canvas>

<script>
let worker,mode='cover',locked=false;
const f={};

document.addEventListener('DOMContentLoaded',async()=>{
['020','100','245','250','264','700','520'].forEach(t=>f[t]=document.getElementById('f-'+t));

worker=await Tesseract.createWorker({
 logger:m=>{
   if(m.status==='recognizing text'){
     document.getElementById('ocr-bar').style.width=Math.round(m.progress*100)+'%';
   }
 }
});
await worker.loadLanguage('eng');
await worker.initialize('eng');

const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
video.srcObject=stream;
video-container.style.display='block';
status.innerText='Ready';
});

function setMode(m){mode=m;status.innerText='Mode: '+m;}

function crop(y1,y2){
const c=document.createElement('canvas');
c.width=canvas.width;c.height=y2-y1;
c.getContext('2d').drawImage(canvas,0,y1,canvas.width,y2-y1,0,0,canvas.width,y2-y1);
return c;
}

async function scanPage(){
status.innerText='Scanningâ€¦';
const ctx=canvas.getContext('2d');
canvas.width=video.videoWidth;canvas.height=video.videoHeight;
ctx.filter='grayscale(1) contrast(1.6)';
ctx.drawImage(video,0,0);

let roi,psm;
if(mode==='cover'){roi=crop(0,canvas.height*0.6);psm=Tesseract.PSM.SPARSE_TEXT;}
if(mode==='verso'){roi=crop(canvas.height*0.6,canvas.height);psm=Tesseract.PSM.SINGLE_BLOCK;}
if(mode==='back'){roi=canvas;psm=Tesseract.PSM.AUTO;}

await worker.setParameters({tessedit_pageseg_mode:psm});
const {data}=await worker.recognize(roi);

if(mode==='cover') parseCover(data.text);
if(mode==='verso') parseVerso(data.text);
if(mode==='back')  parseBack(data.text);

status.innerText='Done';
}

function setField(tag,val,conf){
if(locked && ['020','245','264','520'].includes(tag))return;
f[tag].innerText=val;
f[tag].className='marc-field '+conf;
}

function parseCover(t){
const lines=t.split('\n').map(l=>l.trim()).filter(l=>l.length>3);
const title=lines.sort((a,b)=>b.length-a.length)[0];
const author=lines.find(l=>l.split(' ').length<=4);
if(title) setField('245',`$a ${title} / $c ${authorityName(author||'')}`,'conf-mid');
if(author) setField('100',`$a ${authorityName(author)}, $e author.`,'conf-mid');
}

async function parseVerso(t){
const isbn=t.match(/97[89]\d{10}/);
if(isbn){
setField('020',`$a ${isbn[0]}`,'conf-high');
googleBooks(isbn[0]);
}
const year=t.match(/\d{4}/);
if(year) setField('264',`$a  : $b  , $c ${year[0]}`,'conf-mid');
}

function parseBack(t){
setField('520',`$a ${t.replace(/\n+/g,' ')}`,'conf-mid');
}

async function googleBooks(isbn){
const r=await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
const j=await r.json();
if(j.totalItems>0){
const i=j.items[0].volumeInfo;
setField('245',`$a ${i.title} / $c ${(i.authors||[]).map(authorityName).join('; ')}`,'conf-high');
setField('264',`$a  : $b ${i.publisher||''}, $c ${i.publishedDate?.slice(0,4)||''}`,'conf-high');
setField('520',`$a ${i.description||''}`,'conf-high');
locked=true;
}
}

/* -------- Authority -------- */
function authorityName(n){
if(!n)return'';
n=n.replace(/edited by|translated by|herausgegeben von/ig,'').trim();
if(n.includes(','))return n;
const p=n.split(/\s+/);
return p.length>1?`${p.pop()}, ${p.join(' ')}`:n;
}

/* -------- Output -------- */
function copyMARC(){
let out='';
Object.keys(f).forEach(k=>{
const v=f[k].innerText.trim();
if(v.length>5) out+=`${k}  ${v}\n`;
});
navigator.clipboard.writeText(out);
alert('MARC copied');
}

function exportMRC(){
let txt='';
Object.keys(f).forEach(k=>{
const v=f[k].innerText.trim();
if(v.length>5) txt+=`=${k}  ${v}\n`;
});
const blob=new Blob([txt],{type:'text/plain'});
const a=document.createElement('a');
a.href=URL.createObjectURL(blob);
a.download='record.mrc';
a.click();
}
</script>

</body>
</html>
