<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Western MARC v70</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont;background:#f6f7f9;margin:0}
header{text-align:center;padding:18px;font-size:26px;font-weight:700}
.mode{display:flex;justify-content:center;gap:10px}
.mode button{padding:10px 16px;border-radius:14px;border:none;font-size:16px;opacity:.5}
.mode button.active{opacity:1;background:#2563eb;color:white}
#scan{width:90%;margin:16px auto;padding:18px;font-size:22px;background:black;color:white;border-radius:16px}
#scan[disabled]{background:#666}
.status{width:90%;margin:0 auto 12px;font-size:14px;color:#444}
.progress{height:8px;background:#ddd;border-radius:8px;overflow:hidden}
.bar{height:100%;width:0;background:#2563eb;transition:.3s}
.card{background:white;margin:16px;padding:16px;border-radius:16px}
label{font-weight:600}
input,textarea,select{width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #ddd}
</style>
</head>

<body>

<header>Western MARC v70</header>

<div class="mode">
<button id="mCover" onclick="setMode('cover')">ğŸ“• å°é¢</button>
<button id="mCopy" onclick="setMode('copyright')">ğŸ“„ ç‰ˆæ¬Šé </button>
<button id="mBack" onclick="setMode('back')">ğŸ“˜ å°åº•</button>
</div>

<div class="status" id="status">è«‹é¸æ“‡é é¢ä¸¦æŒ‰ SCAN</div>
<div class="progress"><div class="bar" id="bar"></div></div>

<button id="scan" onclick="scan()">SCAN</button>

<div class="card">
<label>020 ISBN</label><input id="f020">
<label>100</label><input id="f100">
<label>110</label><input id="f110">
<label>245</label><input id="f245">
<label>264</label><input id="f264">
<label>520</label><textarea id="f520"></textarea>
<label>700</label><input id="f700">
</div>

<script>
let mode='cover';
setMode('cover');

function setMode(m){
  mode=m;
  ['mCover','mCopy','mBack'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if(m==='cover') mCover.classList.add('active');
  if(m==='copyright') mCopy.classList.add('active');
  if(m==='back') mBack.classList.add('active');
  status.textContent='å·²é¸æ“‡ï¼š'+(m==='cover'?'å°é¢':m==='copyright'?'ç‰ˆæ¬Šé ':'å°åº•');
}

/* ===== Scan ===== */
async function scan(){
  const file=await pickImage();
  if(!file) return;

  lockUI(true);
  setProgress(10,'å½±åƒä¸Šå‚³ä¸­â€¦');

  try{
    setProgress(40,'OCR è¾¨è­˜ä¸­â€¦');
    const text=await ocr(file);

    setProgress(70,'MARC è¦å‰‡å¥—ç”¨ä¸­â€¦');
    applyMARC(text);

    setProgress(100,'å®Œæˆ');
  }catch(e){
    status.textContent='ç™¼ç”ŸéŒ¯èª¤ï¼š'+e.message;
  }

  setTimeout(()=>lockUI(false),500);
}

function lockUI(b){
  scan.disabled=b;
}

/* ===== Progress ===== */
function setProgress(p,msg){
  bar.style.width=p+'%';
  status.textContent=msg;
}

/* ===== Image Picker ===== */
function pickImage(){
  return new Promise(r=>{
    const i=document.createElement('input');
    i.type='file';i.accept='image/*';
    i.onchange=()=>r(i.files[0]);
    i.click();
  });
}

/* ===== OCR.space ===== */
async function ocr(file){
  const fd=new FormData();
  fd.append('apikey','K82186283388957');
  fd.append('language','auto');
  fd.append('file',file);

  const res=await fetch('https://api.ocr.space/parse/image',{method:'POST',body:fd});
  const j=await res.json();
  return j.ParsedResults[0].ParsedText;
}

/* ===== MARC ===== */
function applyMARC(t){
  if(mode==='cover'){
    if(!f245.value) f245.value=t.split('\n')[0];
    if(!f100.value){
      const m=t.match(/by\s+([^\n]+)/i);
      if(m) f100.value=invert(m[1]);
    }
  }
  if(mode==='copyright'){
    const y=t.match(/\b(19|20)\d{2}\b/);
    if(y && !f264.value) f264.value='$c '+y[0];
    const isbn=t.match(/\b97[89]\d{10}\b/);
    if(isbn && !f020.value) f020.value=isbn[0];
  }
  if(mode==='back'){
    if(!f520.value) f520.value=t.slice(0,700);
  }
}

function invert(n){
  const p=n.trim().split(' ');
  return p.length>1?p.pop()+', '+p.join(' '):n;
}
</script>

</body>
</html>
