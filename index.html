<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Western MARC v70</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont;background:#f6f7f9;margin:0}
header{text-align:center;padding:18px;font-size:26px;font-weight:700}
.mode{display:flex;justify-content:center;gap:10px;margin-bottom:10px}
.mode button{padding:10px 16px;border-radius:14px;border:none;font-size:16px}
#scan{width:90%;margin:14px auto;padding:18px;font-size:22px;background:black;color:white;border-radius:16px}
.card{background:white;margin:16px;padding:16px;border-radius:16px}
label{font-weight:600}
input,textarea,select{width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #ddd}
small{color:#666}
</style>
</head>

<body>

<header>Western MARC v70</header>

<div class="mode">
<button onclick="setMode('cover')">ğŸ“• å°é¢</button>
<button onclick="setMode('copyright')">ğŸ“„ ç‰ˆæ¬Šé </button>
<button onclick="setMode('back')">ğŸ“˜ å°åº•</button>
</div>

<div class="card">
<label>OCR èªè¨€</label>
<select id="lang">
  <option value="eng">English</option>
  <option value="rus">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
  <option value="jpn">æ—¥æœ¬èª</option>
  <option value="chi_sim">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
  <option value="chi_tra">ä¸­æ–‡ï¼ˆç¹é«”ï¼‰</option>
  <option value="spa">EspaÃ±ol</option>
  <option value="fra">FranÃ§ais</option>
  <option value="deu">Deutsch</option>
  <option value="ita">Italiano</option>
  <option value="auto">Auto Detect</option>
</select>
<small>ï¼ˆOCR.space æ”¯æ´ 28+ èªè¨€ï¼‰</small>
</div>

<button id="scan" onclick="scan()">SCAN</button>

<div class="card">
<label>020 ISBN</label>
<input id="f020">
<label>100 Personal Author</label>
<input id="f100">
<label>110 Corporate Author</label>
<input id="f110">
<label>245 Title</label>
<input id="f245">
<label>264 Publication</label>
<input id="f264">
<label>520 Summary</label>
<textarea id="f520"></textarea>
<label>700 Added Entry</label>
<input id="f700">
</div>

<script>
/* ================= åŸºæœ¬ç‹€æ…‹ ================= */
let mode='cover';
function setMode(m){mode=m;alert('æ¨¡å¼ï¼š'+m)}

/* ================= Scan ================= */
async function scan(){
  const file=await pickImage();
  if(!file) return;
  const text=await ocr(file);
  applyMARC(text);
}

/* ================= Image Picker ================= */
function pickImage(){
  return new Promise(r=>{
    const i=document.createElement('input');
    i.type='file';i.accept='image/*';
    i.onchange=()=>r(i.files[0]);
    i.click();
  });
}

/* ================= OCR.space ================= */
async function ocr(file){
  const fd=new FormData();
  fd.append('apikey','K82186283388957');
  fd.append('language',document.getElementById('lang').value);
  fd.append('file',file);

  const res=await fetch('https://api.ocr.space/parse/image',{method:'POST',body:fd});
  const j=await res.json();
  return j.ParsedResults[0].ParsedText;
}

/* ================= MARC Engine ================= */
function applyMARC(t){

  if(mode==='cover'){
    if(!f245.value) f245.value=titleRule(t);
    if(!f100.value) f100.value=authorRule(t);
    if(!f110.value) f110.value=corpRule(t);
  }

  if(mode==='copyright'){
    if(!f264.value) f264.value=pubRule(t);
    if(!f020.value){
      const isbn=isbnRule(t);
      if(isbn){
        f020.value=isbn;
        googleBooks(isbn);
      }
    }
  }

  if(mode==='back'){
    if(!f520.value) f520.value=summaryRule(t);
    if(!f700.value) f700.value=addedRule(t);
  }
}

/* ================= Rules ================= */
function titleRule(t){
  return t.split('\n')[0].trim();
}

function authorRule(t){
  const m=t.match(/by\s+([^\n]+)/i);
  return m?invert(m[1]):'';
}

function corpRule(t){
  const m=t.match(/([A-Z][A-Za-z ]+(Press|University|Institute))/);
  return m?m[1]:'';
}

function pubRule(t){
  const y=t.match(/\b(19|20)\d{2}\b/);
  const p=t.match(/Published by\s+([^,\n]+)/i);
  return y||p?`${p?'$b '+p[1]:''} ${y?'$c '+y[0]:''}`:'';
}

function summaryRule(t){
  return t.slice(0,700);
}

function addedRule(t){
  const m=t.match(/(edited|translated) by ([^\n]+)/i);
  return m?`${invert(m[2])}, $e ${m[1]}`:'';
}

function isbnRule(t){
  const m=t.match(/\b97[89][- ]?\d{1,5}[- ]?\d+[- ]?\d+[- ]?\d\b/);
  return m?m[0].replace(/[- ]/g,''):'';
}

function invert(n){
  const p=n.trim().split(' ');
  return p.length>1?p.pop()+', '+p.join(' '):n;
}

/* ================= Google Booksï¼ˆè¼”åŠ©ï¼‰ ================= */
async function googleBooks(isbn){
  const r=await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
  const j=await r.json();
  if(!j.items) return;

  const v=j.items[0].volumeInfo;

  if(!f245.value && v.title) f245.value=v.title;
  if(!f100.value && v.authors) f100.value=invert(v.authors[0]);

  /* âš ï¸ æ‘˜è¦åƒ…åœ¨ 520 ç©ºç™½æ™‚è£œ */
  if(!f520.value && v.description) f520.value=v.description;
}
</script>

</body>
</html>
