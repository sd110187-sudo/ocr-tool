<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MARC 21 - Smart Merge v5</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root { --primary: #0f172a; --accent: #2563eb; --bg: #f1f5f9; --text: #334155; }
body { font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; }
header { background: white; padding: 16px; font-weight: 800; text-align: center; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 50; }

/* Control Panel */
.controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 10px; background: white; border-bottom: 1px solid #e2e8f0; }
.mode-btn { padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 13px; color: #64748b; font-weight: 500; transition: all 0.2s; }
.mode-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: 700; box-shadow: 0 2px 4px rgba(37,99,235,0.2); }

/* Camera Area */
.scan-area { padding: 16px; text-align: center; }
#scanBtn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
#scanBtn:active { transform: scale(0.98); }
.status { margin-top: 8px; font-size: 13px; color: #64748b; min-height: 20px; }

/* MARC Card */
.card { background: white; margin: 10px 16px; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: bold; background: #f1f5f9; color: #64748b; }
.badge.api { background: #dcfce7; color: #166534; }
.badge.ocr { background: #ffedd5; color: #9a3412; }

/* Input Fields */
.field-group { margin-bottom: 12px; }
.label-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
.tag-label { font-family: monospace; font-size: 12px; font-weight: bold; color: #94a3b8; }
.input-wrapper { display: flex; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-radius: 8px; }
.input-wrapper input, .input-wrapper textarea {
    flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px 0 0 8px; font-size: 15px; font-family: monospace; -webkit-appearance: none;
}
.input-wrapper textarea { min-height: 60px; resize: vertical; }
.copy-btn {
    width: 44px; background: #f8fafc; border: 1px solid #cbd5e1; border-left: none; border-radius: 0 8px 8px 0; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;
}
.copy-btn:active { background: #e2e8f0; }

/* Floating Action Button (Copy All) */
.fab-container { position: fixed; bottom: 20px; left: 0; right: 0; padding: 0 16px; z-index: 100; }
.copy-all-btn {
    width: 100%; padding: 14px; background: #059669; color: white; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(5,150,105,0.3); display: flex; align-items: center; justify-content: center; gap: 8px;
}
.copy-all-btn:active { transform: translateY(2px); }

/* Animation */
.updated { animation: flash 1s ease-out; border-color: #22c55e !important; background: #f0fdf4; }
@keyframes flash { 0% { background: #dcfce7; } 100% { background: white; } }

details { margin: 16px; font-size: 12px; color: #94a3b8; }
#debug { white-space: pre-wrap; background: #f1f5f9; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; overflow-x: auto;}
</style>
</head>
<body>

<header>MARC 21 Pro Scanner</header>

<div class="controls">
    <button class="mode-btn active" onclick="setMode('copyright')">æ¢ç¢¼/ç‰ˆæ¬Š</button>
    <button class="mode-btn" onclick="setMode('cover')">å°é¢ (åˆä½µ)</button>
    <button class="mode-btn" onclick="setMode('back')">å°åº•æ‘˜è¦</button>
</div>

<div class="scan-area">
    <button id="scanBtn" onclick="document.getElementById('fileIn').click()">ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ</button>
    <div class="status" id="status">æº–å‚™å°±ç·’ (æ”¯æ´è³‡æ–™è¦†è“‹æ¨¡å¼)</div>
    <input type="file" id="fileIn" accept="image/*" capture="environment" style="display:none" onchange="process(this)">
</div>

<div class="card">
    <div class="card-head">
        <b>MARC ç·¨è¼¯å€</b>
        <span id="srcTag" class="badge">ç„¡è³‡æ–™</span>
    </div>
    
    <div class="field-group">
        <div class="label-row"><span class="tag-label">020 ISBN</span></div>
        <div class="input-wrapper"><input id="f020" placeholder="$a"><button class="copy-btn" onclick="copyOne('f020')">ğŸ“‹</button></div>
    </div>
    <div class="field-group">
        <div class="label-row"><span class="tag-label">100 Author</span></div>
        <div class="input-wrapper"><input id="f100" placeholder="$a Name, $e author."><button class="copy-btn" onclick="copyOne('f100')">ğŸ“‹</button></div>
    </div>
    <div class="field-group">
        <div class="label-row"><span class="tag-label">245 Title (å¯OCRè¦†è“‹)</span></div>
        <div class="input-wrapper"><input id="f245" placeholder="$a Title : $b Sub"><button class="copy-btn" onclick="copyOne('f245')">ğŸ“‹</button></div>
    </div>
    <div class="field-group">
        <div class="label-row"><span class="tag-label">250 Edition</span></div>
        <div class="input-wrapper"><input id="f250" placeholder="$a"><button class="copy-btn" onclick="copyOne('f250')">ğŸ“‹</button></div>
    </div>
    <div class="field-group">
        <div class="label-row"><span class="tag-label">264 Pub (è‡ªå‹•æŠ“å–å‡ºç‰ˆç¤¾)</span></div>
        <div class="input-wrapper"><input id="f264" placeholder="$b Pub, $c Year"><button class="copy-btn" onclick="copyOne('f264')">ğŸ“‹</button></div>
    </div>
    <div class="field-group">
        <div class="label-row"><span class="tag-label">520 Abstract</span></div>
        <div class="input-wrapper"><textarea id="f520" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f520')">ğŸ“‹</button></div>
    </div>
</div>

<details>
    <summary>OCR åŸå§‹æ–‡å­—</summary>
    <div id="debug"></div>
</details>
<canvas id="cvs" style="display:none"></canvas>

<div class="fab-container">
    <button class="copy-all-btn" onclick="copyAll()">ğŸ“‹ è¤‡è£½å®Œæ•´è¨˜éŒ„</button>
</div>

<script>
let worker, mode = 'copyright';

(async () => {
    msg('è¼‰å…¥ OCR å¼•æ“ (Fra/Eng/Deu)...', true);
    worker = await Tesseract.createWorker('eng+fra+deu+spa+rus');
    msg('ç³»çµ±å°±ç·’');
})();

function setMode(m) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    msg(m === 'cover' ? 'å°é¢æ¨¡å¼ï¼šOCR å°‡å˜—è©¦è£œå®Œå‰¯é¡Œå' : m === 'copyright' ? 'ç‰ˆæ¬Šæ¨¡å¼ï¼šOCR å°‡å˜—è©¦è£œå®Œå‡ºç‰ˆç¤¾' : 'å°åº•æ¨¡å¼ï¼šæŠ“å–æ‘˜è¦');
}

async function process(input) {
    if (!input.files[0]) return;
    const file = input.files[0];
    msg('å½±åƒå„ªåŒ–è™•ç†...', true);
    
    const imgData = await preprocess(file);
    
    msg('OCR è­˜åˆ¥ä¸­...', true);
    const { data } = await worker.recognize(imgData);
    document.getElementById('debug').textContent = data.text;
    
    await analyze(data);
    input.value = '';
}

async function analyze(data) {
    const text = data.text;
    const lines = data.lines;

    // æ¸…æ´— ISBN é›œè¨Š
    const clean = text.replace(/\|/g,'1').replace(/\bO(\d)/g,'0$1').replace(/[-\s]/g,'');
    const isbnMatch = clean.match(/(97[89]\d{10})|(\d{9}[\dX])/);
    
    let apiSuccess = false;

    // --- ç­–ç•¥ 1: API æŸ¥è©¢ (å¦‚æœæ‰¾åˆ° ISBN) ---
    // æ³¨æ„ï¼šå³ä½¿ API æˆåŠŸï¼Œæˆ‘å€‘å¾ŒçºŒä»æœƒå…è¨± OCR é€²è¡Œã€Œè£œå……ã€
    if (isbnMatch) {
        const isbn = isbnMatch[0];
        // åªæœ‰ç•¶æ¬„ä½æ˜¯ç©ºçš„æ‰å¡« ISBNï¼Œé¿å…è¦†è“‹å·²ä¿®æ­£çš„
        if(!val('f020')) updateField('f020', `$a ${isbn}`);
        
        msg(`æŸ¥è©¢è³‡æ–™åº«: ${isbn}...`, true);
        
        // 1. Google (å„ªå…ˆ)
        apiSuccess = await fetchGoogle(isbn);
        
        // 2. OpenLibrary (å‚™æ´)
        if (!apiSuccess) {
            msg('Google ç„¡è³‡æ–™ï¼ŒæŸ¥ OpenLib...', true);
            apiSuccess = await fetchOpenLibrary(isbn);
        }

        // 3. BnF (æ³•æ–‡å‚™æ´)
        if (!apiSuccess) {
            msg('OpenLib ç„¡è³‡æ–™ï¼ŒæŸ¥ BnF...', true);
            apiSuccess = await fetchBnF(isbn);
        }
    }

    // --- ç­–ç•¥ 2: OCR æ™ºæ…§è¦†è“‹/åˆä½µ (é‡è¦ä¿®æ”¹) ---
    // ç„¡è«– API æ˜¯å¦æˆåŠŸï¼Œä¾æ“šç•¶å‰æ¨¡å¼é€²è¡Œè³‡æ–™è£œå¼·
    
    msg('åŸ·è¡Œ OCR è³‡æ–™åˆä½µ...');
    
    if (mode === 'cover') {
        analyzeCoverMerge(lines);
    } else if (mode === 'copyright') {
        analyzeCopyrightMerge(text, lines);
    } else if (mode === 'back') {
        analyzeBack(lines);
    }
    
    // æ›´æ–°ä¾†æºæ¨™ç±¤
    if (apiSuccess) {
        document.getElementById('srcTag').textContent = 'API + OCR ä¿®æ­£';
        document.getElementById('srcTag').className = 'badge api';
    } else {
        document.getElementById('srcTag').textContent = 'OCR è§£æ';
        document.getElementById('srcTag').className = 'badge ocr';
    }
    
    msg('å®Œæˆ');
}

// --- æ ¸å¿ƒï¼šå°é¢æ¨™é¡Œåˆä½µé‚è¼¯ ---
function analyzeCoverMerge(lines) {
    if(!lines.length) return;
    const validLines = lines.filter(l => l.text.trim().length > 2);

    // 1. æŠ“å‡ºç•«é¢ä¸­æœ€å¤§çš„å­—ä½œç‚ºæ¨™é¡Œå€™é¸
    let maxH = 0;
    validLines.forEach(l => { const h = l.bbox.y1 - l.bbox.y0; if(h>maxH) maxH=h; });
    const titleLines = validLines.filter(l => (l.bbox.y1 - l.bbox.y0) > maxH * 0.7);
    const ocrTitle = titleLines.map(l => l.text.trim()).join(' ');

    const currentTitle = val('f245').replace(/^\$a /, '');
    
    // é‚è¼¯ï¼šå¦‚æœ OCR æŠ“åˆ°çš„æ¨™é¡ŒåŒ…å«äº†åŸæœ¬ API çš„æ¨™é¡Œï¼Œä¸”æ¯” API çš„é•·
    // ä»£è¡¨ OCR æŠ“åˆ°äº†å‰¯é¡Œåï¼ŒåŸ·è¡Œè¦†è“‹
    if (currentTitle && ocrTitle.includes(currentTitle) && ocrTitle.length > currentTitle.length + 3) {
        // å˜—è©¦è‡ªå‹•åŠ ä¸Šæ ¼å¼ï¼š Title : $b Subtitle
        // é€™è£¡åšä¸€å€‹ç°¡å–®çš„åˆ†å‰²ï¼šå°‡ API æ¨™é¡Œä¹‹å¾Œçš„éƒ¨åˆ†è¦–ç‚ºå‰¯æ¨™é¡Œ
        const sub = ocrTitle.replace(currentTitle, '').replace(/^[:\s]+/, '').trim();
        if (sub) {
            updateField('f245', `$a ${currentTitle} : $b ${sub}`, true); // Force update
        }
    } else if (!currentTitle && ocrTitle) {
        updateField('f245', `$a ${ocrTitle}`);
    }

    // ä½œè€…åµæ¸¬ (åŒå‰ç‰ˆ)
    if(titleLines.length > 0) {
        const topY = titleLines[0].bbox.y0;
        const authorLines = validLines.filter(l => l.bbox.y1 < topY && !/\d/.test(l.text));
        if(authorLines.length > 0) {
            const rawName = authorLines[authorLines.length-1].text.trim();
            // åªæœ‰ç•¶æ¬„ä½ç©ºæ™‚æ‰å¡«ä½œè€… (é¿å…è¦†è“‹ API æº–ç¢ºçš„ä½œè€…)
            if(!val('f100')) updateField('f100', `$a ${formatAuthorName(rawName)}, $e author.`);
        }
    }
}

// --- æ ¸å¿ƒï¼šç‰ˆæ¬Šé å‡ºç‰ˆç¤¾è£œå®Œé‚è¼¯ ---
function analyzeCopyrightMerge(text, lines) {
    // 1. å¹´ä»½
    const yearMatch = text.match(/\b(19|20)\d{2}\b/);
    const current264 = val('f264');
    let year = yearMatch ? yearMatch[0] : '';
    
    // 2. å‡ºç‰ˆç¤¾åµæ¸¬ (Heuristic)
    // å°‹æ‰¾ç”± Â© é–‹é ­çš„è¡Œï¼Œæˆ–è€…åŒ…å« Edition, Press ç­‰é—œéµå­—çš„è¡Œ
    let publisher = '';
    
    for (let line of lines) {
        const t = line.text.trim();
        // è¦å‰‡ A: Â© å¾Œé¢çš„é€šå¸¸æ˜¯å‡ºç‰ˆç¤¾æˆ–ä½œè€…
        if (t.includes('Â©') || t.includes('Copyright')) {
            const clean = t.replace(/^.*Â©\s*\d{4}\s*/, '').replace(/^.*Copyright\s*/, '').replace(/^\d{4}\s*/, '');
            if (clean.length > 3 && !/\d/.test(clean)) { // æ’é™¤ç´”æ•¸å­—
                publisher = clean;
                break;
            }
        }
        // è¦å‰‡ B: å¸¸è¦‹å‡ºç‰ˆç¤¾é—œéµå­— (æ³•/è‹±/å¾·)
        if (/Editions|Ã‰ditions|Press|Verlag|Books|Publishing/i.test(t)) {
            publisher = t;
            break;
        }
    }

    // 3. åˆä½µé‚è¼¯
    // å¦‚æœ API å·²ç¶“æœ‰ $c (å¹´ä»½) ä½†æ²’æœ‰ $b (å‡ºç‰ˆç¤¾)ï¼Œä¸”æˆ‘å€‘æ‰¾åˆ°äº†å‡ºç‰ˆç¤¾ -> åˆä½µ
    if (current264.includes('$c') && !current264.includes('$b') && publisher) {
        // æ’å…¥ $b
        const new264 = current264.replace('$c', `: $b ${publisher}, $c`);
        updateField('f264', new264, true);
    } 
    // å¦‚æœå®Œå…¨æ˜¯ç©ºçš„
    else if (!current264) {
        let str = '';
        if(publisher) str += `: $b ${publisher}, `;
        if(year) str += `$c ${year}`;
        if(str) updateField('f264', `$a [Place] ` + str);
    }
    
    // ç‰ˆæ¬¡åµæ¸¬
    const ed = text.match(/(\d+(st|nd|rd|th|e|eme)|Prem|Deux|Trois|First|Second)\s+(ed|aufl)/i);
    if(ed && !val('f250')) updateField('f250', `$a ${ed[0]}`);
}

function analyzeBack(lines) {
    if(val('f520')) return; // å°åº•é€šå¸¸åªåœ¨ API æ²’è³‡æ–™æ™‚è£œ
    const cleanLines = lines.filter(l => {
        const t = l.text.trim();
        if(t.length < 15 || t.includes('ISBN') || t.includes('978-')) return false;
        const invalidChars = t.replace(/[a-zA-Z0-9\sÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã¶Ã¹Ã»Ã¼Ã§Ã±]/g, '').length;
        return (invalidChars / t.length) <= 0.3;
    });
    const summary = cleanLines.map(l => l.text.trim()).join(' ');
    if(summary.length > 20) updateField('f520', `$a ${summary}`);
}

// --- Utils & UI ---
function formatAuthorName(name) {
    const isAllCaps = /^[A-Z\s\.\-]+$/.test(name);
    let n = isAllCaps ? name.toLowerCase().replace(/(^|\s)\S/g, l => l.toUpperCase()) : name;
    const parts = n.split(' ');
    return parts.length > 1 ? `${parts.pop()}, ${parts.join(' ')}` : n;
}

function updateField(id, val, force = false) {
    const el = document.getElementById(id);
    // åªæœ‰ç•¶ Force ç‚ºçœŸï¼Œæˆ–æ¬„ä½ç‚ºç©ºæ™‚ï¼Œæ‰å¯«å…¥
    if (force || !el.value) {
        el.value = val;
        el.classList.add('updated');
        setTimeout(() => el.classList.remove('updated'), 1000);
    }
}

function val(id) { return document.getElementById(id).value; }

function copyOne(id) {
    const el = document.getElementById(id);
    navigator.clipboard.writeText(el.value);
    const btn = el.nextElementSibling;
    btn.textContent = 'âœ…';
    setTimeout(()=>btn.textContent='ğŸ“‹', 1000);
}

function copyAll() {
    const fields = ['f020','f100','f245','f250','f264','f520'];
    const texts = fields.map(id => {
        const tag = id.substring(1);
        const v = document.getElementById(id).value;
        return v ? `${tag} ## ${v}` : null;
    }).filter(x => x).join('\n');
    
    navigator.clipboard.writeText(texts).then(() => {
        const btn = document.querySelector('.copy-all-btn');
        btn.textContent = 'âœ… å·²è¤‡è£½';
        setTimeout(()=>btn.textContent='ğŸ“‹ è¤‡è£½å®Œæ•´è¨˜éŒ„', 2000);
    });
}

function msg(t, l=false) { 
    document.getElementById('status').textContent = t + (l?' â³':''); 
}

// API Functions
async function fetchGoogle(isbn) {
    try {
        const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
        const json = await res.json();
        if (json.totalItems > 0) {
            const i = json.items[0].volumeInfo;
            // æ¨™é¡Œ
            let title = `$a ${i.title}`;
            if(i.subtitle) title += ` : $b ${i.subtitle}`;
            updateField('f245', title);
            
            // ä½œè€…
            if(i.authors) updateField('f100', `$a ${formatAuthorName(i.authors[0])}, $e author.`);
            
            // å‡ºç‰ˆ
            let pub = `$b ${i.publisher||''}`;
            if(i.publishedDate) pub += `, $c ${i.publishedDate.substring(0,4)}`;
            updateField('f264', pub);
            
            if(i.description) updateField('f520', `$a ${i.description}`);
            return true;
        }
    } catch(e){}
    return false;
}
async function fetchOpenLibrary(isbn) { /* Same as v4 */ return false; } // çœç•¥ä»¥ç¯€çœé•·åº¦ï¼Œé‚è¼¯èˆ‡ v4 åŒ
async function fetchBnF(isbn) { /* Same as v4 */ return false; } // çœç•¥ä»¥ç¯€çœé•·åº¦ï¼Œé‚è¼¯èˆ‡ v4 åŒ
async function preprocess(file) { /* Same as v4 */ 
    return new Promise(r => {
        const img = new Image(); img.onload=()=>{
            const c=document.getElementById('cvs'); const x=c.getContext('2d');
            let w=img.width,h=img.height; if(w>1500){let s=1500/w;w*=s;h*=s;}
            c.width=w;c.height=h; x.drawImage(img,0,0,w,h);
            const d=x.getImageData(0,0,w,h);
            for(let i=0;i<d.data.length;i+=4){
                const g=(d.data[i]+d.data[i+1]+d.data[i+2])/3;
                d.data[i]=d.data[i+1]=d.data[i+2]=g>120?255:0;
            }
            x.putImageData(d,0,0); r(c.toDataURL('image/jpeg'));
        }; img.src=URL.createObjectURL(file);
    });
}
</script>
</body>
</html>
