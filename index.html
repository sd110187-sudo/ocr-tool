<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Smart MARC - Pro Layout Analysis</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root { --primary: #4f46e5; --bg: #f3f4f6; }
body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
header { background: white; padding: 16px; font-weight: 800; text-align: center; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 50; }

.controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 12px; background: white; }
.mode-btn { padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; background: white; font-size: 13px; color: #4b5563; }
.mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }

.action-area { padding: 16px; text-align: center; }
#scanBtn { width: 100%; padding: 16px; background: #111827; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
#scanBtn:disabled { opacity: 0.7; }

.status { margin-top: 12px; font-size: 13px; color: #6b7280; font-weight: 500; min-height: 20px; }

/* MARC Form */
.card { background: white; margin: 12px 16px; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.source-tag { font-size: 10px; padding: 4px 8px; border-radius: 12px; background: #f3f4f6; color: #6b7280; font-weight: 700; }
.source-tag.api { background: #dbeafe; color: #1e40af; }
.source-tag.ocr { background: #fef3c7; color: #92400e; }

.row { display: flex; margin-bottom: 10px; align-items: center; }
.tag { width: 35px; font-family: monospace; font-weight: bold; color: #9ca3af; font-size: 14px; }
input, textarea { flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; width: 100%; transition: border 0.2s; }
textarea { min-height: 70px; resize: vertical; }
.filled { border-color: #22c55e; background: #f0fdf4; }

/* Tools */
.tools { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
.tool-btn { font-size: 12px; padding: 4px 10px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; }

details { margin: 16px; font-size: 12px; color: #6b7280; }
#debug { white-space: pre-wrap; background: #e5e7eb; padding: 8px; border-radius: 8px; margin-top: 8px; }
</style>
</head>
<body>

<header>MARC 21 Pro Scanner</header>

<div class="controls">
    <button class="mode-btn active" onclick="setMode('copyright')">æ¢ç¢¼/ç‰ˆæ¬Š</button>
    <button class="mode-btn" onclick="setMode('cover')">å°é¢åˆ†æ</button>
    <button class="mode-btn" onclick="setMode('back')">å°åº•æ‘˜è¦</button>
</div>

<div class="action-area">
    <button id="scanBtn" onclick="document.getElementById('inp').click()">ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ</button>
    <div class="status" id="status">æº–å‚™å°±ç·’ (æ”¯æ´ OpenAlex/Google)</div>
    <input type="file" id="inp" accept="image/*" capture="environment" style="display:none" onchange="handleFile(this)">
</div>

<div class="card">
    <div class="card-head">
        <b>MARC è³‡æ–™</b>
        <span id="srcTag" class="source-tag">å¾…è¼¸å…¥</span>
    </div>
    
    <div class="row"><div class="tag">020</div><input id="f020" placeholder="$a ISBN"></div>
    <div class="row"><div class="tag">100</div><input id="f100" placeholder="$a Author"></div>
    <div class="row"><div class="tag">245</div><input id="f245" placeholder="$a Title"></div>
    <div class="row"><div class="tag">250</div><input id="f250" placeholder="$a Edition"></div>
    <div class="row"><div class="tag">264</div><input id="f264" placeholder="$c Year"></div>
    <div class="row"><div class="tag">520</div><textarea id="f520" placeholder="$a Abstract"></textarea></div>

    <div class="tools">
        <button class="tool-btn" onclick="swapFields()">ğŸ”„ äº¤æ› ä½œè€…/æ›¸å</button>
        <button class="tool-btn" onclick="clearFields()">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>
</div>

<details>
    <summary>é¡¯ç¤ºåŸå§‹è­˜åˆ¥æ–‡å­—</summary>
    <div id="debug"></div>
</details>

<canvas id="cvs" style="display:none"></canvas>

<script>
let worker, mode = 'copyright';

(async () => {
    msg('è¼‰å…¥ OCR å¼•æ“...', true);
    worker = await Tesseract.createWorker('eng+fra+deu+spa'); // åŠ å…¥æ›´å¤šèªè¨€åŒ…
    msg('ç³»çµ±å°±ç·’');
})();

function setMode(m) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    msg(`åˆ‡æ›æ¨¡å¼: ${m}`);
}

async function handleFile(input) {
    if (!input.files[0]) return;
    const file = input.files[0];
    msg('å½±åƒå„ªåŒ–è™•ç†...', true);
    
    // 1. å½±åƒé è™•ç†
    const imgData = await preprocess(file);
    
    msg('OCR åˆ†ææ’ç‰ˆçµæ§‹...', true);
    // 2. ç²å–è©³ç´°è³‡è¨Š (åŒ…å«æ–‡å­—åº§æ¨™)
    const { data } = await worker.recognize(imgData);
    
    document.getElementById('debug').textContent = data.text;
    
    // 3. æ™ºæ…§åˆ†æ
    await analyze(data);
    input.value = '';
}

async function analyze(data) {
    const text = data.text;
    const lines = data.lines; // Tesseract çš„è¡Œè³‡è¨Š (å«åº§æ¨™)

    // æ¸…æ´—æ–‡å­—
    const cleanText = text.replace(/\|/g, 'I').replace(/\bO(\d)/g, '0$1');
    const isbnMatch = cleanText.match(/(97[89]\d{9}[\dxX])|(\d{9}[\dxX])/);

    let apiSuccess = false;

    // --- ç­–ç•¥ A: å„ªå…ˆç”¨ ISBN æŸ¥åº« (Google + OpenAlex) ---
    if (isbnMatch) {
        const isbn = isbnMatch[0].replace(/-/g,'');
        fill('f020', `$a ${isbn}`);
        
        msg(`æŸ¥å°‹è³‡æ–™åº« ISBN: ${isbn}...`, true);
        
        // 1. æŸ¥ Google Books
        apiSuccess = await fetchGoogle(isbn);
        
        // 2. å¦‚æœæ²’è³‡æ–™ï¼ŒæŸ¥ OpenAlex (å­¸è¡“å¼·é …)
        if (!apiSuccess) {
            msg('Google ç„¡è³‡æ–™ï¼ŒæŸ¥è©¢ OpenAlex...', true);
            apiSuccess = await fetchOpenAlex(isbn);
        }
    }

    // --- ç­–ç•¥ B: OCR æ™ºæ…§ä½ˆå±€åˆ†æ (Layout Analysis) ---
    if (!apiSuccess) {
        msg('API ç„¡è³‡æ–™ï¼Œä½¿ç”¨ä½ˆå±€åˆ†æå¡«å…¥');
        document.getElementById('srcTag').textContent = 'OCR ä½ˆå±€åˆ†æ';
        document.getElementById('srcTag').className = 'source-tag ocr';
        
        if (mode === 'cover') {
            applyCoverLayout(lines);
        } else if (mode === 'copyright') {
            applyCopyrightLogic(cleanText);
        } else if (mode === 'back') {
             if(!getValue('f520')) fill('f520', '$a ' + text.replace(/\n/g, ' ').slice(0, 500));
        }
    } else {
        msg('è³‡æ–™ç²å–æˆåŠŸ');
    }
}

// --- æ ¸å¿ƒæ”¹é€²ï¼šåŸºæ–¼å­—é«”å¤§å°çš„å°é¢åˆ†æ ---
function applyCoverLayout(lines) {
    if (!lines || lines.length === 0) return;

    // æ‰¾å‡ºã€Œæœ€é«˜ã€çš„è¡Œï¼ˆå­—é«”æœ€å¤§ï¼‰-> è¦–ç‚ºæ›¸å
    let maxLineHeight = 0;
    let titleIndex = -1;

    // è¨ˆç®—æ¯ä¸€è¡Œçš„é«˜åº¦
    lines.forEach((line, index) => {
        if (line.text.trim().length < 2) return; // å¿½ç•¥é›œè¨Š
        const height = line.bbox.y1 - line.bbox.y0;
        if (height > maxLineHeight) {
            maxLineHeight = height;
            titleIndex = index;
        }
    });

    if (titleIndex !== -1) {
        // 1. å¡«å…¥æ›¸å (å­—é«”æœ€å¤§è€…)
        // æœ‰æ™‚å€™æ›¸åæœƒè·¨å…©è¡Œï¼Œæª¢æŸ¥ titleIndex çš„ä¸‹ä¸€è¡Œå­—é«”æ˜¯å¦ä¹Ÿå¾ˆå¤§
        let titleText = lines[titleIndex].text.trim();
        // ç°¡å–®é‚è¼¯ï¼šå¦‚æœä¸‹ä¸€è¡Œé«˜åº¦ä¹Ÿæ˜¯æœ€å¤§é«˜åº¦çš„ 80% ä»¥ä¸Šï¼Œè¦–ç‚ºå‰¯æ¨™é¡Œæˆ–æ¨™é¡Œä¸€éƒ¨åˆ†
        if (lines[titleIndex + 1]) {
            const nextH = lines[titleIndex+1].bbox.y1 - lines[titleIndex+1].bbox.y0;
            if (nextH > maxLineHeight * 0.7) {
                titleText += " : $b " + lines[titleIndex+1].text.trim();
            }
        }
        if (!getValue('f245')) fill('f245', '$a ' + titleText);

        // 2. å¡«å…¥ä½œè€… (é€šå¸¸åœ¨æ›¸åã€Œä¸Šæ–¹ã€ä¸”å­—é«”è¼ƒå°)
        // æˆ–æ˜¯æ›¸åä¸‹æ–¹å¾ˆé è™•
        if (!getValue('f100')) {
            let potentialAuthor = '';
            // å¾€ä¸Šçœ‹
            for (let i = 0; i < titleIndex; i++) {
                const t = lines[i].text.trim();
                if (t.length > 3 && !/\d/.test(t)) { // æ²’æœ‰æ•¸å­—
                    potentialAuthor = t;
                    break; // æŠ“åˆ°ç¬¬ä¸€å€‹æ‡‰è©²å°±æ˜¯
                }
            }
            // å¦‚æœä¸Šé¢æ²’æ±è¥¿ï¼Œå¾€ä¸‹çœ‹ (é€šå¸¸åœ¨æœ€ä¸‹é¢)
            if (!potentialAuthor) {
                for (let i = lines.length - 1; i > titleIndex; i--) {
                     const t = lines[i].text.trim();
                     if (t.length > 3 && !/\d/.test(t) && t.length < 30) { 
                        potentialAuthor = t;
                        break;
                     }
                }
            }
            if(potentialAuthor) fill('f100', '$a ' + potentialAuthor + ', $e author.');
        }
    }
    
    // é †ä¾¿æ‰¾ç‰ˆæ¬¡ (ç„¡è«–å“ªä¸€è¡Œ)
    findEdition(lines.map(l=>l.text).join('\n'));
}

function applyCopyrightLogic(text) {
    // æ‰¾å¹´ä»½
    const year = text.match(/\b(19|20)\d{2}\b/);
    if(year && !getValue('f264')) fill('f264', '$c ' + year[0]);
    findEdition(text);
}

// --- å¢å¼·ç‰ˆæ¬¡åµæ¸¬ (å¤šèªè¨€) ---
function findEdition(text) {
    if (getValue('f250')) return;
    
    // æ”¯æ´ï¼šFr(Ã©dition), En(edition), De(Auflage), Es(ediciÃ³n)
    // æ”¯æ´ï¼š3e, 3Ã¨me, 3rd, 3.
    const regex = /(PremiÃ¨re|DeuxiÃ¨me|TroisiÃ¨me|QuatriÃ¨me|CinquiÃ¨me|SixiÃ¨me|\d+(er|re|e|Ã¨me|de|th|rd|nd|st)\.?)\s+(Ã©d|Ed|Aufl)/i;
    const match = text.match(regex);
    
    if (match) {
        // æŠ“æ•´å¥ï¼Œä¾‹å¦‚ "TroisiÃ¨me Ã©dition"
        // é€™è£¡åšä¸€å€‹ç°¡å–®çš„æå–ï¼šæŠ“ match é™„è¿‘çš„ä¸€æ•´æ®µ
        // ç°¡å–®é»ï¼Œç›´æ¥å¡«å…¥ match åˆ°çš„å­—ä¸²æ“´å……ä¸€é»
        const exact = text.substring(match.index, match.index + 20).split('\n')[0]; 
        fill('f250', '$a ' + exact);
    } else {
        // é—œéµå­—è£œæ¼
        const simple = text.match(/(Nouvelle|New|Rev\.|Revue)\s+(Ã©d|Ed)/i);
        if(simple) fill('f250', '$a ' + simple[0]);
    }
}

// --- API ---

async function fetchGoogle(isbn) {
    try {
        const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
        const json = await res.json();
        if (json.totalItems > 0) {
            const info = json.items[0].volumeInfo;
            fillData('Google Books', info.authors, info.title, info.subtitle, info.publisher, info.publishedDate, info.description);
            return true;
        }
    } catch(e){}
    return false;
}

async function fetchOpenAlex(isbn) {
    try {
        // OpenAlex æ˜¯ä¸€å€‹å·¨å¤§çš„é–‹æ”¾å­¸è¡“åœ–è­œ
        const res = await fetch(`https://api.openalex.org/works?filter=isbn:${isbn}`);
        const json = await res.json();
        if (json.meta.count > 0) {
            const work = json.results[0];
            const authors = work.authorships.map(a => a.author.display_name);
            const pub = work.primary_location?.source?.display_name || '';
            const date = work.publication_year;
            fillData('OpenAlex', authors, work.title, '', pub, date, '');
            return true;
        }
    } catch(e){ console.log(e); }
    return false;
}

function fillData(source, authors, title, sub, pub, date, desc) {
    document.getElementById('srcTag').textContent = 'ä¾†æº: ' + source;
    document.getElementById('srcTag').className = 'source-tag api';
    
    if(authors && authors.length) fill('f100', `$a ${authors[0]}, $e author.`);
    let fullTitle = `$a ${title}`;
    if(sub) fullTitle += ` : $b ${sub}`;
    fill('f245', fullTitle);
    
    let pubStr = '';
    if(pub) pubStr += `: $b ${pub}, `;
    if(date) pubStr += `$c ${date}`;
    if(pubStr) fill('f264', `$a [Place] ` + pubStr);
    
    if(desc) fill('f520', `$a ${desc}`);
}

// --- Utils ---
function preprocess(file) {
    return new Promise(r => {
        const img = new Image();
        img.onload = () => {
            const c = document.getElementById('cvs');
            const x = c.getContext('2d');
            // é™åˆ¶æœ€å¤§å¯¬åº¦ä»¥æå‡é€Ÿåº¦
            const scale = Math.min(1500/img.width, 1);
            c.width = img.width * scale;
            c.height = img.height * scale;
            x.drawImage(img,0,0,c.width,c.height);
            // å¢å¼·å°æ¯” (ç°¡å–®ç‰ˆ)
            const d = x.getImageData(0,0,c.width,c.height);
            for(let i=0;i<d.data.length;i+=4){
                const g = d.data[i]*0.3 + d.data[i+1]*0.59 + d.data[i+2]*0.11;
                const v = g > 130 ? 255 : 0;
                d.data[i]=d.data[i+1]=d.data[i+2]=v;
            }
            x.putImageData(d,0,0);
            r(c.toDataURL('image/jpeg'));
        };
        img.src = URL.createObjectURL(file);
    });
}

function fill(id, v) { 
    const el = document.getElementById(id);
    el.value = v; 
    el.classList.add('filled');
    setTimeout(()=>el.classList.remove('filled'), 1000);
}
function getValue(id) { return document.getElementById(id).value; }
function msg(t, l=false) { 
    const el = document.getElementById('status');
    el.textContent = t + (l?' â³':'');
    document.getElementById('scanBtn').disabled = l;
}
function swapFields() {
    const a = document.getElementById('f100').value;
    const t = document.getElementById('f245').value;
    document.getElementById('f100').value = t.replace(/^\$a /, '$a ').replace(/, \$e author\.$/, '');
    document.getElementById('f245').value = a.replace(/^\$a /, '$a ');
}
function clearFields() {
    ['f020','f100','f245','f250','f264','f520'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('srcTag').textContent = 'å¾…è¼¸å…¥';
    document.getElementById('srcTag').className = 'source-tag';
}
</script>
</body>
</html>
