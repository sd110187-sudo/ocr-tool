<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Western MARC Scanner v70</title>

<!-- âš ï¸ ç©©å®šç‰ˆï¼ˆGitHub Pages å¯ç”¨ï¼‰ -->
<script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.marc{font-family:Courier New,monospace;border:2px solid #e5e7eb;padding:6px;border-radius:10px}
#videoBox{display:none;border-radius:24px;overflow:hidden}
</style>
</head>

<body class="bg-slate-50 p-4">

<div class="max-w-xl mx-auto space-y-4">

<h1 class="text-center font-black text-xl">Western MARC v70</h1>

<div id="status" class="text-center text-xs text-slate-500">
Initializingâ€¦
</div>

<div class="grid grid-cols-3 gap-2">
<button onclick="mode='cover'" class="bg-blue-600 text-white py-3 rounded-xl">ğŸ“• å°é¢</button>
<button onclick="mode='verso'" class="bg-slate-600 text-white py-3 rounded-xl">ğŸ“„ ç‰ˆæ¬Šé </button>
<button onclick="mode='back'" class="bg-emerald-600 text-white py-3 rounded-xl">ğŸ“˜ å°åº•</button>
</div>

<div id="videoBox" class="aspect-[4/5] bg-black">
<video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
</div>

<div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
<div id="bar" class="bg-blue-600 h-2 w-0"></div>
</div>

<button id="scanBtn" onclick="scan()" disabled
 class="w-full bg-black text-white py-4 rounded-2xl font-bold">
SCAN
</button>

<div class="bg-white rounded-2xl shadow p-4 space-y-1 text-xs">
<div>020<div id="f020" class="marc"></div></div>
<div>100<div id="f100" class="marc"></div></div>
<div>245<div id="f245" class="marc"></div></div>
<div>520<div id="f520" class="marc"></div></div>
</div>

</div>

<canvas id="c" class="hidden"></canvas>

<script>
let worker,mode='cover',ready=false;

const statusEl=document.getElementById('status');
const bar=document.getElementById('bar');
const scanBtn=document.getElementById('scanBtn');

(async()=>{
 try{
  statusEl.innerText='Initializing OCR engineâ€¦';

  worker=Tesseract.createWorker({
   logger:m=>{
    if(m.status==='recognizing text'){
     bar.style.width=Math.round(m.progress*100)+'%';
    }
   }
  });

  await worker.load();
  statusEl.innerText='Loading language dataâ€¦';
  await worker.loadLanguage('eng');
  await worker.initialize('eng');

  statusEl.innerText='Starting cameraâ€¦';
  const stream=await navigator.mediaDevices.getUserMedia({
   video:{facingMode:'environment'}
  });
  video.srcObject=stream;
  document.getElementById('videoBox').style.display='block';

  ready=true;
  scanBtn.disabled=false;
  statusEl.innerText='Ready to scan';

 }catch(e){
  statusEl.innerText='Initialization failed';
  console.error(e);
 }
})();

async function scan(){
 if(!ready)return;
 scanBtn.disabled=true;
 statusEl.innerText='Capturing imageâ€¦';

 const ctx=c.getContext('2d');
 c.width=video.videoWidth;
 c.height=video.videoHeight;
 ctx.drawImage(video,0,0);

 statusEl.innerText='Running OCRâ€¦';
 const {data}=await worker.recognize(c);

 if(mode==='cover'){
  const lines=data.text.split('\n').map(l=>l.trim()).filter(l=>l);
  document.getElementById('f245').innerText='$a '+(lines[0]||'');
  document.getElementById('f100').innerText='$a '+(lines[1]||'');
 }

 if(mode==='back'){
  document.getElementById('f520').innerText='$a '+data.text.replace(/\n+/g,' ');
 }

 statusEl.innerText='Scan complete';
 scanBtn.disabled=false;
}
</script>

</body>
</html>
