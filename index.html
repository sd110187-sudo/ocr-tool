<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MARC 21 - v10.0 (Pub+Place)</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root { --primary: #0f172a; --accent: #059669; --bg: #f8fafc; --text: #334155; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 140px; }
header { background: white; padding: 14px; font-weight: 800; text-align: center; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 50; }

/* Controls */
.controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; padding: 8px; background: white; border-bottom: 1px solid #e2e8f0; }
.mode-btn { padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 13px; color: #64748b; font-weight: 600; }
.mode-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

/* Camera */
.action-area { padding: 12px; background: white; margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; }
#scanBtn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
.search-box { display: flex; gap: 8px; }
.search-input { flex: 1; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; }
.search-btn { padding: 8px 16px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; font-weight: 600; color: #475569; }
.status { margin-top: 8px; font-size: 12px; color: #64748b; text-align: center; min-height: 18px; font-weight: 500;}

/* MARC Card */
.card { background: white; margin: 0 12px; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: bold; background: #f1f5f9; color: #64748b; }
.badge.api { background: #dcfce7; color: #166534; }
.badge.reject { background: #fee2e2; color: #991b1b; }
.badge.ocr { background: #ffedd5; color: #9a3412; }

/* Fields */
.field-group { margin-bottom: 12px; }
.tag-label { font-family: monospace; font-size: 11px; font-weight: bold; color: #94a3b8; display: block; margin-bottom: 2px; }
.input-wrapper { display: flex; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; background: #fff; transition: all 0.3s; }
.scroll-input {
    flex: 1; padding: 12px; font-size: 16px; font-family: monospace; border: none; outline: none;
    white-space: nowrap; overflow-x: auto; overflow-y: hidden; resize: none;
}
.multiline { white-space: normal; min-height: 80px; }
.copy-btn { width: 44px; background: #f8fafc; border-left: 1px solid #cbd5e1; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
.copy-btn:active { background: #e2e8f0; }
.locked-field { border: 2px solid #f59e0b !important; background: #fffbeb; }
.safe-field { border: 2px solid #22c55e !important; background: #f0fdf4; }
.rejected-field { border: 2px solid #ef4444 !important; animation: shake 0.4s; }
@keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

details { margin: 16px; font-size: 11px; color: #94a3b8; }
#debug { white-space: pre-wrap; background: #f1f5f9; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; overflow-x: hidden; word-break: break-all;}
.fab-container { position: fixed; bottom: 20px; left: 0; right: 0; padding: 0 16px; z-index: 100; pointer-events: none; }
.copy-all-btn { pointer-events: auto; width: 100%; padding: 14px; background: #059669; color: white; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(5,150,105,0.3); }
</style>
</head>
<body>

<header>MARC 21 - v10.0 (Pub+Place)</header>

<div class="controls">
    <button class="mode-btn active" onclick="setMode('copyright')">ç‰ˆæ¬Šé  (éŒ¨é»)</button>
    <button class="mode-btn" onclick="setMode('cover')">å°é¢/æ‰‰é  (åæŸ¥)</button>
    <button class="mode-btn" onclick="setMode('back')">å°åº•æ‘˜è¦</button>
</div>

<div class="action-area">
    <button id="scanBtn" onclick="document.getElementById('fileIn').click()">ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ</button>
    <div class="search-box">
        <input type="text" id="manualQuery" class="search-input" placeholder="OCRå¤±æ•—æ™‚æ‰‹å‹•æœ...">
        <button class="search-btn" onclick="manualSearch()">ğŸ”</button>
    </div>
    <div class="status" id="status">å»ºè­°ï¼šæ‹æ”ã€Œæ‰‰é ã€åº•éƒ¨å¯æŠ“å–å‡ºç‰ˆåœ°</div>
    <input type="file" id="fileIn" accept="image/*" capture="environment" style="display:none" onchange="process(this)">
</div>

<div class="card">
    <div class="card-head"><b>MARC è¨˜éŒ„</b><span id="srcTag" class="badge">ç„¡è³‡æ–™</span></div>
    <div class="field-group"><span class="tag-label">020 ISBN</span><div class="input-wrapper"><textarea id="f020" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f020')">ğŸ“‹</button></div></div>
    <div class="field-group"><span class="tag-label">100 Author</span><div class="input-wrapper"><textarea id="f100" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f100')">ğŸ“‹</button></div></div>
    <div class="field-group"><span class="tag-label">245 Title ($c è²¬ä»»è€…)</span><div class="input-wrapper"><textarea id="f245" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f245')">ğŸ“‹</button></div></div>
    <div class="field-group"><span class="tag-label">250 Edition</span><div class="input-wrapper"><textarea id="f250" class="scroll-input" rows="1" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f250')">ğŸ“‹</button></div></div>
    <div class="field-group"><span class="tag-label">264 Pub ($a åœ°é» : $b å‡ºç‰ˆè€…)</span><div class="input-wrapper" id="wrap264"><textarea id="f264" class="scroll-input" rows="1" placeholder="$a [Place] : $b Pub, $c Year"></textarea><button class="copy-btn" onclick="copyOne('f264')">ğŸ“‹</button></div></div>
    <div class="field-group"><span class="tag-label">520 Abstract</span><div class="input-wrapper"><textarea id="f520" class="scroll-input multiline" placeholder="$a"></textarea><button class="copy-btn" onclick="copyOne('f520')">ğŸ“‹</button></div></div>
</div>

<details><summary>Debug</summary><div id="debug"></div></details>
<canvas id="cvs" style="display:none"></canvas>
<div class="fab-container"><button class="copy-all-btn" onclick="copyAll()">ğŸ“‹ è¤‡è£½å®Œæ•´è¨˜éŒ„</button></div>

<script>
let worker, mode = 'copyright';

// --- è³‡æ–™åº«ï¼šå‡ºç‰ˆé‡é®èˆ‡æ©Ÿæ§‹é—œéµå­— ---
const DB_CITIES = [
    'Paris','London','New York','Berlin','MÃ¼nchen','Frankfurt','Wien','Madrid','Barcelona','Roma','Milano','Bruxelles','Amsterdam','Taipei','Tokyo','Beijing','Shanghai','Hong Kong','Singapore','Sydney','Toronto','Chicago','Boston','Oxford','Cambridge','Princeton','Geneva','Lausanne','ZÃ¼rich','Stuttgart','KÃ¶ln','Hamburg'
];

const DB_PUBS = [
    'Press','University','Verlag','Editions','Ã‰ditions','Librairie','Gallimard','Penguin','Routledge','Springer','Wiley','Elsevier','Hachette','Seuil','PUF','Flammarion','Albin Michel','Fayard','Dunod','Larousse','Nathan','Bordas','Colin','Ellipses','Eyrolles','Dalloz','Sirey','LGDJ','LexisNexis','Francis Lefebvre','Pedone','Hermann','Vrin','Cerf','Labor','De Boeck','Larcier','Bruylant','Peter Lang','Nomos','Beck','Mohr Siebeck','De Gruyter','Brill','Nijhoff','Hart','Sweet & Maxwell'
];

(async () => {
    msg('è¼‰å…¥ OCR...', true);
    worker = await Tesseract.createWorker('eng+fra+deu+spa');
    msg('ç³»çµ±å°±ç·’');
})();

function setMode(m) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    msg(m === 'cover' ? 'å°é¢/æ‰‰é ï¼šå¼·åŠ›åµæ¸¬å‡ºç‰ˆåœ°' : 'ç‰ˆæ¬Šé ï¼šæŠ“å–å¹´ä»½');
}

async function process(input) {
    if (!input.files[0]) return;
    const file = input.files[0];
    document.getElementById('manualQuery').value = '';
    msg('å½±åƒè™•ç†ä¸­...', true);
    const imgData = await preprocess(file);
    msg('OCR è­˜åˆ¥ä¸­...', true);
    const { data } = await worker.recognize(imgData);
    document.getElementById('debug').textContent = data.text;
    await analyze(data);
    input.value = '';
}

async function analyze(data) {
    const text = data.text;
    const lines = data.lines;
    const clean = text.replace(/\|/g,'1').replace(/\bO(\d)/g,'0$1').replace(/[-\s]/g,'');
    const isbnMatch = clean.match(/(97[89]\d{10})|(\d{9}[\dX])/);
    const existingYear = extractYear(val('f264'));
    let success = false;

    // A. API æµç¨‹
    if (isbnMatch) {
        msg(`ISBN ${isbnMatch[0]} å‘½ä¸­`, true);
        success = await fetchGoogle(`isbn:${isbnMatch[0]}`, existingYear, null);
        if(!success) success = await fetchOpenLibrary(isbnMatch[0]);
    }

    // B. åæŸ¥æµç¨‹
    if (!success && mode === 'cover') {
        const extracted = extractKeywords(lines);
        if (extracted.query.length > 3) {
            document.getElementById('manualQuery').value = extracted.cleanTitle; 
            msg(`åæŸ¥: ${extracted.cleanTitle}...`, true);
            success = await fetchGoogle(extracted.query, existingYear, extracted.cleanTitle); 
        }
    }

    // C. OCR è£œå¼· (æ ¸å¿ƒï¼šå‡ºç‰ˆåœ°/å‡ºç‰ˆç¤¾çµäºº)
    msg('åŸ·è¡Œæ©Ÿæ§‹èˆ‡åœ°é»åµæ¸¬...');
    
    // å…¨åŸŸåµæ¸¬ï¼šå‡ºç‰ˆåœ° ($a) èˆ‡ å‡ºç‰ˆç¤¾ ($b)
    detectPublisherAndPlace(lines, text);

    // ç‰ˆæ¬¡ ($250)
    const edition = extractEdition(text);
    if(edition) updateField('f250', `$a ${edition}`, true);

    // è²¬ä»»è€… ($c) - åƒ…å°é¢æ¨¡å¼
    if (mode === 'cover') {
        detectResponsibility(lines);
        // å¦‚æœ API æ²’è³‡æ–™ï¼Œç”¨ OCR è£œæ¨™é¡Œ
        if (!success && !val('f245')) {
            const title = extractTitleFromOCR(lines);
            if(title) updateField('f245', `$a ${title}`);
        }
    } else if (mode === 'copyright') {
        // ç‰ˆæ¬Šé æ¨¡å¼åŠ å¼·å¹´ä»½
        const year = extractYear(text);
        if (year && !val('f264').includes(year)) {
            // ä¿ç•™å·²æœ‰çš„ $a $bï¼Œåªæ›´æ–° $c
            let current = val('f264') || '';
            if(!current.includes('$c')) updateField('f264', `${current} $c ${year}`, true);
        }
    }
    
    // æ‘˜è¦ (å°åº•)
    if (mode === 'back') analyzeBack(lines);

    if (!success && !val('f245')) {
        document.getElementById('srcTag').textContent = 'OCR è§£æ';
        document.getElementById('srcTag').className = 'badge ocr';
    }
    msg('å®Œæˆ');
}

// --- æ ¸å¿ƒï¼šå‡ºç‰ˆåœ°èˆ‡å‡ºç‰ˆç¤¾åµæ¸¬å¼•æ“ ---
function detectPublisherAndPlace(lines, fullText) {
    let foundPlace = '';
    let foundPub = '';

    // 1. æœå°‹å·²çŸ¥åŸå¸‚ (Case Insensitive)
    for (let city of DB_CITIES) {
        if (new RegExp(`\\b${city}\\b`, 'i').test(fullText)) {
            foundPlace = city;
            break; // æ‰¾åˆ°ä¸€å€‹å°±åœï¼Œé¿å…å¤šé‡åœ°é»æ··äº‚
        }
    }

    // 2. æœå°‹å·²çŸ¥å‡ºç‰ˆç¤¾é—œéµå­—
    // ç­–ç•¥ï¼šæ‰¾åŒ…å«é—œéµå­—çš„ã€Œé‚£ä¸€è¡Œã€ï¼Œä¸¦æå–æ•´è¡Œ
    for (let line of lines) {
        const txt = line.text.trim();
        if (txt.length < 3) continue;

        // æª¢æŸ¥æ˜¯å¦åŒ…å« Publisher Keyword
        const hasPubKw = DB_PUBS.some(kw => new RegExp(`\\b${kw}\\b`, 'i').test(txt));
        
        // æª¢æŸ¥æ˜¯å¦åŒ…å« Â© (ç‰ˆæ¬Šé å¸¸è¦‹)
        const hasCopy = txt.includes('Â©') || txt.includes('Copyright');

        if ((hasPubKw || hasCopy) && !foundPub) {
            // æ¸…æ´—ï¼šç§»é™¤ Â© 20xx ä¹‹é¡çš„å¹´ä»½
            let cleanPub = txt.replace(/Â©\s*\d{4}/, '').replace(/Copyright/i, '').trim();
            // ç§»é™¤ç´”æ•¸å­—
            if (!/^[\d\s]+$/.test(cleanPub) && cleanPub.length > 3) {
                foundPub = cleanPub;
            }
        }
    }

    // 3. é å°¾ç­–ç•¥ (Footer Strategy) - åƒ…åœ¨å°é¢/æ‰‰é æ¨¡å¼
    // é€šå¸¸æ‰‰é æœ€ä¸‹é¢ä¸€è¡Œå°±æ˜¯å‡ºç‰ˆç¤¾+åœ°é»
    if (mode === 'cover' && (!foundPub || !foundPlace)) {
        const validLines = lines.filter(l => l.text.trim().length > 3);
        if (validLines.length > 0) {
            // å–æœ€å¾Œä¸€è¡Œ (Bottom line)
            const lastLine = validLines[validLines.length - 1].text.trim();
            
            // å¦‚æœé‚„æ²’æ‰¾åˆ°åœ°é»ï¼Œä¸”æœ€å¾Œä¸€è¡Œåƒåœ°é» (åŒ…å«é€—è™Ÿæˆ–å·²çŸ¥åŸå¸‚)
            if (!foundPlace && (lastLine.includes(',') || DB_CITIES.some(c=>lastLine.includes(c)))) {
                 // ç°¡å–®å‡è¨­ï¼šæœ€å¾Œä¸€è¡Œå¯èƒ½æ˜¯ "City : Publisher" æˆ– "City, Year"
                 // é€™è£¡ä¸åšéåº¦æ¨æ–·ï¼Œåƒ…ç•¶ä½œå¾Œå‚™
            }
            
            // å¦‚æœé‚„æ²’æ‰¾åˆ°å‡ºç‰ˆç¤¾ï¼Œä¸”æœ€å¾Œä¸€è¡Œä¸æ˜¯ ISBN
            if (!foundPub && !lastLine.includes('ISBN') && !/\d{4}/.test(lastLine)) {
                foundPub = lastLine;
            }
        }
    }

    // 4. åˆä½µè‡³ 264 æ¬„ä½
    const current264 = val('f264');
    let new264 = current264;

    // å¦‚æœç›®å‰æ²’æœ‰ $a (åœ°é») ä¸”æ‰¾åˆ°äº†åœ°é»
    if (!current264.includes('$a') && foundPlace) {
        // å¦‚æœæ˜¯ç©ºçš„ï¼Œç›´æ¥å¡«
        if (!new264) new264 = `$a ${foundPlace} :`;
        else new264 = `$a ${foundPlace} : ` + new264.replace('$a [Place] :', ''); // æ›¿æ›ä½”ä½ç¬¦
    } else if (current264.includes('[Place]') && foundPlace) {
         new264 = new264.replace('[Place]', foundPlace);
    }

    // å¦‚æœç›®å‰æ²’æœ‰ $b (å‡ºç‰ˆè€…) ä¸”æ‰¾åˆ°äº†å‡ºç‰ˆè€…
    if (!current264.includes('$b') && foundPub) {
        // ç¢ºä¿æ ¼å¼æ­£ç¢º
        if (!new264) new264 = `: $b ${foundPub},`;
        else if (new264.includes(':')) new264 = new264.replace(':', `: $b ${foundPub},`); 
        else new264 += ` : $b ${foundPub},`;
    }

    // å¯«å…¥æ›´æ–°
    if (new264 !== current264) {
        updateField('f264', new264, true);
    }
}

// --- è²¬ä»»è€…çµäºº ($c) ---
function detectResponsibility(lines) {
    const validLines = lines.filter(l => l.text.trim().length > 2);
    // æ‰¾æ¨™é¡Œä¸‹æ–¹å€åŸŸ
    let maxH = 0, titleIdx = -1;
    validLines.forEach((l, i) => { const h = l.bbox.y1 - l.bbox.y0; if(h>maxH) { maxH=h; titleIdx=i; }});
    
    let statement = [];
    if (titleIdx >= 0) {
        const titleBottomY = validLines[titleIdx].bbox.y1;
        for (let i = 0; i < validLines.length; i++) {
            const line = validLines[i];
            if (line.bbox.y0 > titleBottomY) {
                const t = line.text.trim();
                // æ“´å……é—œéµå­—
                if (/^(par|by|von|textes|trad|edit|pref|intro|prÃ©sentÃ©s|choisis|translated|edited|foreword)/i.test(t) || t.includes('UniversitÃ©') || t.includes('Sorbonne') || t.includes('Professor')) {
                    statement.push(t);
                }
            }
        }
    }
    if (statement.length > 0) {
        const st = statement.join(' ');
        const cur = val('f245');
        if (cur && !cur.includes('$c')) updateField('f245', `${cur} / $c ${st}`, true);
    }
}

// --- Google API (å«é˜²ç«ç‰†) ---
async function fetchGoogle(query, localYear, validationText) {
    try {
        const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=5`;
        const res = await fetch(url);
        const json = await res.json();
        if (json.totalItems > 0) {
            let bestItem = json.items[0];
            if (validationText) {
                const sim = checkSimilarity(validationText, bestItem.volumeInfo.title||"");
                if (sim < 0.3) {
                    msg(`ğŸš« æ””æˆªï¼APIçµæœä¸ç¬¦`, false);
                    document.getElementById('f245').parentElement.classList.add('rejected-field');
                    return false;
                }
            }
            if (localYear) {
                const y = parseInt(localYear);
                const m = json.items.find(x => { const iy = parseInt(extractYear(x.volumeInfo.publishedDate||'')); return !isNaN(iy) && Math.abs(iy-y)<=2; });
                if(m) bestItem = m;
            }

            const i = bestItem.volumeInfo;
            // æ¨™é¡Œ
            let t = `$a ${i.title}`; if(i.subtitle) t+=` : $b ${i.subtitle}`;
            updateField('f245', t, true);
            // ä½œè€…
            if(i.authors) updateField('f100', `$a ${formatAuthorName(i.authors[0])}, $e author.`, true);
            
            // å‡ºç‰ˆè³‡è¨Š (å„ªå…ˆä½¿ç”¨ APIï¼Œä½†ä¿ç•™ $a ç©ºé–“çµ¦ OCR å¡«)
            let pubStr = '';
            // å¦‚æœ OCR å·²ç¶“æƒåˆ°äº†åœ°é»ï¼Œä¿ç•™å®ƒ
            const currentPlace = val('f264').match(/\$a\s+([^:]+)/)?.[1] || '[Place]';
            
            pubStr += `$a ${currentPlace} : `;
            if(i.publisher) pubStr += `$b ${i.publisher}, `;
            if(i.publishedDate) pubStr += `$c ${i.publishedDate.substring(0,4)}`;
            
            // åªæœ‰åœ¨æ²’é–å®šçš„æƒ…æ³ä¸‹æ›´æ–°
            if(!document.getElementById('wrap264').classList.contains('locked-field')) {
                updateField('f264', pubStr, true);
                // å¦‚æœå¹´ä»½å·®ç•°å¤ªå¤§ï¼Œé–å®š
                const apiY = extractYear(i.publishedDate||'');
                if(localYear && apiY && Math.abs(parseInt(localYear)-parseInt(apiY))>3) lockField('wrap264');
            }

            if(i.description && val('f520').length<50) updateField('f520', `$a ${i.description}`);
            if(i.industryIdentifiers && !val('f020')) {
                const isbn = i.industryIdentifiers.find(x=>x.type==='ISBN_13');
                if(isbn) updateField('f020', `$a ${isbn.identifier}`);
            }
            document.getElementById('srcTag').textContent = 'API å‘½ä¸­';
            document.getElementById('srcTag').className = 'badge api';
            return true;
        }
    } catch(e){}
    return false;
}

// Utils (ä¿æŒ v9)
function checkSimilarity(s1,s2){if(!s1||!s2)return 0;const t=s=>s.toLowerCase().replace(/[^\w\s]/g,'').split(/\s+/).filter(w=>w.length>2);const a=new Set(t(s1)),b=new Set(t(s2));let i=0;a.forEach(w=>{if(b.has(w))i++});const m=Math.min(a.size,b.size);return m===0?0:i/m}
function extractTitleFromOCR(l){const v=l.filter(x=>x.text.trim().length>2);let m=0;v.forEach(x=>{const h=x.bbox.y1-x.bbox.y0;if(h>m)m=h});return v.filter(x=>(x.bbox.y1-x.bbox.y0)>m*0.7).map(x=>x.text.trim()).join(' ')}
function extractKeywords(l){const v=l.filter(x=>x.text.trim().length>2);if(!v.length)return{query:'',cleanTitle:''};let m=0,idx=-1;v.forEach((x,i)=>{const h=x.bbox.y1-x.bbox.y0;if(h>m){m=h;idx=i}});let q='',t='';if(idx>=0){t=v[idx].text.trim().replace(/[|\-_â€”]/g,' ').trim();q=`intitle:${t}`;for(let i=0;i<idx;i++){const x=v[i].text.trim();if(x.length>3&&!/\d/.test(x)&&!x.includes('Pline')){q+=`+inauthor:${x.split(' ')[0]}`;break}}}return{query:q,cleanTitle:t}}
function manualSearch(){const q=document.getElementById('manualQuery').value.trim();if(q)fetchGoogle(q,extractYear(val('f264')),null)}
function extractYear(s){const m=s?s.match(/\b(18|19|20)\d{2}\b/):null;return m?m[0]:null}
function lockField(id){document.getElementById(id).classList.add('locked-field')}
function unlockField(id){document.getElementById(id).classList.remove('locked-field')}
function formatAuthorName(n){if(n.includes("'")||n.includes(" d'"))return n;let x=n;if(/^[A-Z\s\.\-',]+$/.test(n))x=n.toLowerCase().replace(/(^|\s)\S/g,l=>l.toUpperCase());const p=x.split(' ');return p.length>1&&!x.includes(',')?`${p.pop()}, ${p.join(' ')}`:x}
function extractEdition(t){const n=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();const m=n.match(/(\d+[\.\s]?(Âª|Âº|a|o|st|nd|rd|th|e|eme|er|re))[\s\.]*(ed|Ã©d|aufl)/i);if(m){const r=t.match(new RegExp(m[1].replace('.','\\.'),'i'));return r?`${r[0]} edition`:m[0]}const x=t.match(/(PremiÃ¨re|DeuxiÃ¨me|TroisiÃ¨me|First|Second)\s+(Ã©d|ed)/i);return x?x[0]:null}
function analyzeBack(l){if(val('f520'))return;const c=l.filter(x=>!x.text.includes('ISBN')&&(x.text.replace(/[^a-z]/gi,'').length/x.text.length)>0.5);const s=c.map(x=>x.text.trim()).join(' ');if(s.length>20)updateField('f520',`$a ${s}`)}
function updateField(id,v,f=false){const e=document.getElementById(id);if(f||!e.value){e.value=v;e.parentElement.classList.add('safe-field');setTimeout(()=>e.parentElement.classList.remove('safe-field'),1200)}}
function val(id){return document.getElementById(id).value}
function copyOne(id){const e=document.getElementById(id);navigator.clipboard.writeText(e.value);const b=e.nextElementSibling;b.textContent='âœ…';setTimeout(()=>b.textContent='ğŸ“‹',1000)}
function copyAll(){const f=['f020','f100','f245','f250','f264','f520'];const t=f.map(k=>{const v=val(k);return v?`${k.substring(1)} ## ${v}`:null}).filter(x=>x).join('\n');navigator.clipboard.writeText(t).then(()=>{const b=document.querySelector('.copy-all-btn');b.textContent='âœ… å·²è¤‡è£½';setTimeout(()=>b.textContent='ğŸ“‹ è¤‡è£½å®Œæ•´è¨˜éŒ„',2000)})}
function msg(t,l){document.getElementById('status').textContent=t+(l?' â³':'')}
async function fetchOpenLibrary(i){return false}
async function preprocess(f){return new Promise(r=>{const i=new Image();i.onload=()=>{const c=document.getElementById('cvs'),x=c.getContext('2d');let w=i.width,h=i.height;if(w>1500){let s=1500/w;w*=s;h*=s}c.width=w;c.height=h;x.drawImage(i,0,0,w,h);const d=x.getImageData(0,0,w,h);for(let k=0;k<d.data.length;k+=4){const g=(d.data[k]+d.data[k+1]+d.data[k+2])/3;d.data[k]=d.data[k+1]=d.data[k+2]=g>100?255:0}x.putImageData(d,0,0);r(c.toDataURL('image/jpeg'))};i.src=URL.createObjectURL(f)})}
</script>
</body>
</html>
