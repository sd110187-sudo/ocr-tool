<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Western MARC â€“ Stable OCR</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
body{font-family:-apple-system;background:#f4f5f7;margin:0}
header{text-align:center;font-size:24px;font-weight:800;padding:16px}
.mode{display:flex;justify-content:center;gap:8px}
.mode button{padding:10px 14px;border:none;border-radius:12px;opacity:.4}
.mode button.active{opacity:1;background:#2563eb;color:white}
#scan{width:90%;margin:16px auto;padding:18px;font-size:22px;background:black;color:white;border-radius:16px}
.status{width:90%;margin:auto;font-size:14px}
pre{background:#eee;padding:12px;border-radius:12px;white-space:pre-wrap;font-size:12px}
.card{background:white;margin:16px;padding:16px;border-radius:16px}
input,textarea{width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #ccc}
.filled{border:2px solid #22c55e}
</style>
</head>

<body>

<header>Western MARC â€“ Stable OCR</header>

<div class="mode">
<button id="mCover" onclick="setMode('cover')">ğŸ“• å°é¢</button>
<button id="mCopy" onclick="setMode('copyright')">ğŸ“„ ç‰ˆæ¬Šé </button>
<button id="mBack" onclick="setMode('back')">ğŸ“˜ å°åº•</button>
</div>

<div class="status" id="status">è«‹é¸æ¨¡å¼å¾ŒæŒ‰ SCAN</div>
<button id="scan" onclick="scan()">SCAN</button>

<div class="card">
<b>OCR åŸæ–‡ï¼ˆä¸€å®šæœƒé¡¯ç¤ºï¼‰</b>
<pre id="ocrText">å°šæœªæƒæ</pre>
</div>

<div class="card">
<label>020</label><input id="f020">
<label>100</label><input id="f100">
<label>245</label><input id="f245">
<label>264</label><input id="f264">
<label>520</label><textarea id="f520"></textarea>
</div>

<script>
let mode='cover';
let worker;

setMode('cover');

function setMode(m){
  mode=m;
  ['mCover','mCopy','mBack'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if(m==='cover') mCover.classList.add('active');
  if(m==='copyright') mCopy.classList.add('active');
  if(m==='back') mBack.classList.add('active');
}

async function scan(){
  const file=await pickImage();
  if(!file) return;

  status.textContent='OCR è¾¨è­˜ä¸­â€¦';

  if(!worker){
    worker=await Tesseract.createWorker('eng+fra+deu+spa+rus');
  }

  const { data } = await worker.recognize(file);
  const text=data.text.trim();

  ocrText.textContent=text || '(OCR ç„¡æ–‡å­—)';
  applyMARC(text);

  status.textContent='å®Œæˆ';
}

function pickImage(){
  return new Promise(r=>{
    const i=document.createElement('input');
    i.type='file';i.accept='image/*';
    i.onchange=()=>r(i.files[0]);
    i.click();
  });
}

function applyMARC(t){
  const lines=t.split('\n').map(l=>l.trim()).filter(l=>l.length>2);

  if(mode==='cover'){
    if(!f245.value && lines[0]){
      f245.value='$a '+lines[0];
      f245.classList.add('filled');
    }
    if(!f100.value && lines[1]){
      f100.value='$a '+invert(lines[1])+', $e author.';
      f100.classList.add('filled');
    }
  }

  if(mode==='copyright'){
    const y=t.match(/\b(19|20)\d{2}\b/);
    if(y && !f264.value){
      f264.value='$c '+y[0];
      f264.classList.add('filled');
    }
    const i=t.match(/\b97[89]\d{10}\b/);
    if(i && !f020.value){
      f020.value='$a '+i[0];
      f020.classList.add('filled');
    }
  }

  if(mode==='back' && !f520.value){
    f520.value='$a '+t.slice(0,700);
    f520.classList.add('filled');
  }
}

function invert(n){
  const p=n.split(' ');
  return p.length>1?p.pop()+', '+p.join(' '):n;
}
</script>

</body>
</html>
