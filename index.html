<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Western MARC v71</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont;background:#f5f6f8;margin:0}
header{text-align:center;padding:18px;font-size:26px;font-weight:800}
.mode{display:flex;justify-content:center;gap:10px}
.mode button{padding:10px 16px;border-radius:14px;border:none;font-size:16px;opacity:.4}
.mode button.active{opacity:1;background:#2563eb;color:white}
#scan{width:90%;margin:16px auto;padding:18px;font-size:22px;background:black;color:white;border-radius:16px}
#scan[disabled]{background:#777}
.status{width:90%;margin:auto;font-size:14px;color:#333}
.progress{width:90%;margin:auto;height:8px;background:#ddd;border-radius:6px;overflow:hidden}
.bar{height:100%;width:0;background:#2563eb;transition:.3s}
.card{background:white;margin:16px;padding:16px;border-radius:16px}
label{font-weight:700}
input,textarea{width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #ddd}
pre{background:#eee;padding:12px;border-radius:10px;font-size:12px;white-space:pre-wrap}
.filled{border:2px solid #22c55e}
</style>
</head>

<body>

<header>Western MARC v71</header>

<div class="mode">
<button id="mCover" onclick="setMode('cover')">ğŸ“• å°é¢</button>
<button id="mCopy" onclick="setMode('copyright')">ğŸ“„ ç‰ˆæ¬Šé </button>
<button id="mBack" onclick="setMode('back')">ğŸ“˜ å°åº•</button>
</div>

<div class="status" id="status">è«‹é¸æ“‡é é¢å¾ŒæŒ‰ SCAN</div>
<div class="progress"><div class="bar" id="bar"></div></div>

<button id="scan" onclick="scan()">SCAN</button>

<div class="card">
<label>OCR åŸæ–‡ï¼ˆé™¤éŒ¯ç”¨ï¼‰</label>
<pre id="ocrText">(å°šæœªæƒæ)</pre>
</div>

<div class="card">
<label>020 ISBN</label><input id="f020">
<label>100</label><input id="f100">
<label>245</label><input id="f245">
<label>264</label><input id="f264">
<label>520</label><textarea id="f520"></textarea>
</div>

<script>
let mode='cover';
setMode('cover');

function setMode(m){
  mode=m;
  ['mCover','mCopy','mBack'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if(m==='cover') mCover.classList.add('active');
  if(m==='copyright') mCopy.classList.add('active');
  if(m==='back') mBack.classList.add('active');
  status.textContent='ç›®å‰æ¨¡å¼ï¼š'+(m==='cover'?'å°é¢':m==='copyright'?'ç‰ˆæ¬Šé ':'å°åº•');
}

async function scan(){
  const file=await pickImage();
  if(!file) return;

  lock(true);
  setProg(20,'ä¸Šå‚³å½±åƒâ€¦');

  const text=await ocr(file);
  ocrText.textContent=text;

  setProg(60,'å¥—ç”¨ MARC è¦å‰‡â€¦');
  applyMARC(text);

  setProg(100,'å®Œæˆ');
  setTimeout(()=>lock(false),500);
}

function lock(b){scan.disabled=b}
function setProg(p,msg){bar.style.width=p+'%';status.textContent=msg}

function pickImage(){
  return new Promise(r=>{
    const i=document.createElement('input');
    i.type='file';i.accept='image/*';
    i.onchange=()=>r(i.files[0]);
    i.click();
  });
}

async function ocr(file){
  const fd=new FormData();
  fd.append('apikey','K82186283388957');
  fd.append('language','auto');
  fd.append('file',file);
  const r=await fetch('https://api.ocr.space/parse/image',{method:'POST',body:fd});
  const j=await r.json();
  return j.ParsedResults[0].ParsedText.trim();
}

/* ===== MARC rules ===== */
function applyMARC(t){
  const lines=t.split('\n').map(l=>l.trim()).filter(l=>l.length>2);

  if(mode==='cover'){
    if(!f245.value && lines[0]){
      f245.value='$a '+lines[0];
      f245.classList.add('filled');
    }
    if(!f100.value && lines[1]){
      f100.value='$a '+invert(lines[1])+', $e author.';
      f100.classList.add('filled');
    }
  }

  if(mode==='copyright'){
    if(!f020.value){
      const i=t.match(/\b97[89]\d{10}\b/);
      if(i){f020.value='$a '+i[0];f020.classList.add('filled')}
    }
    if(!f264.value){
      const y=t.match(/\b(19|20)\d{2}\b/);
      if(y){f264.value='$c '+y[0];f264.classList.add('filled')}
    }
  }

  if(mode==='back' && !f520.value){
    f520.value='$a '+t.slice(0,800);
    f520.classList.add('filled');
  }
}

function invert(n){
  const p=n.split(' ');
  return p.length>1?p.pop()+', '+p.join(' '):n;
}
</script>

</body>
</html>
