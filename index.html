<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Western MARC Stable</title>

<!-- ç©©å®šç‰ˆ Tesseractï¼ˆä¸ä½¿ç”¨ workerï¼‰ -->
<script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.marc{font-family:Courier New,monospace;border:2px solid #e5e7eb;
padding:6px;border-radius:10px;background:#fff}
#videoBox{display:none;border-radius:24px;overflow:hidden}
</style>
</head>

<body class="bg-slate-50 p-4">

<div class="max-w-xl mx-auto space-y-4">

<h1 class="text-center font-black text-xl">Western MARC â€“ Stable</h1>

<div id="status" class="text-center text-xs text-slate-500">
Waiting for user action
</div>

<div class="grid grid-cols-3 gap-2">
<button onclick="setMode('cover')" class="bg-blue-600 text-white py-3 rounded-xl">ğŸ“• å°é¢</button>
<button onclick="setMode('verso')" class="bg-slate-600 text-white py-3 rounded-xl">ğŸ“„ ç‰ˆæ¬Šé </button>
<button onclick="setMode('back')" class="bg-emerald-600 text-white py-3 rounded-xl">ğŸ“˜ å°åº•</button>
</div>

<div id="videoBox" class="aspect-[4/5] bg-black">
<video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
</div>

<button onclick="scan()" class="w-full bg-black text-white py-4 rounded-2xl font-bold">
SCAN
</button>

<div class="bg-white rounded-2xl shadow p-4 space-y-2 text-xs">
<div>020<div id="f020" class="marc"></div></div>
<div>100<div id="f100" class="marc"></div></div>
<div>245<div id="f245" class="marc"></div></div>
<div>520<div id="f520" class="marc"></div></div>
</div>

</div>

<canvas id="c" class="hidden"></canvas>

<script>
let mode=null;
let stream=null;

const statusEl=document.getElementById('status');
const video=document.getElementById('video');
const canvas=document.getElementById('c');

function setMode(m){
 mode=m;
 statusEl.innerText='Starting cameraâ€¦';

 if(stream) return;

 navigator.mediaDevices.getUserMedia({
  video:{facingMode:'environment'}
 }).then(s=>{
  stream=s;
  video.srcObject=s;
  document.getElementById('videoBox').style.display='block';
  statusEl.innerText='Camera ready â€“ press SCAN';
 }).catch(e=>{
  statusEl.innerText='Camera access failed';
 });
}

async function scan(){
 if(!stream || !mode){
  statusEl.innerText='Select page type first';
  return;
 }

 statusEl.innerText='Capturing imageâ€¦';

 const ctx=canvas.getContext('2d');
 canvas.width=video.videoWidth;
 canvas.height=video.videoHeight;
 ctx.drawImage(video,0,0);

 statusEl.innerText='Running OCRâ€¦';

 const result = await Tesseract.recognize(
  canvas,
  'eng',
  { logger:m=>{
     if(m.status==='recognizing text'){
       statusEl.innerText='OCR '+Math.round(m.progress*100)+'%';
     }
   }
  }
 );

 const text=result.data.text.trim();

 if(mode==='cover'){
  const lines=text.split('\n').map(l=>l.trim()).filter(l=>l);
  document.getElementById('f245').innerText='$a '+(lines[0]||'');
  document.getElementById('f100').innerText=
   lines[1] ? '$a '+invertName(lines[1])+', $e author.' : '';
 }

 if(mode==='verso'){
  const isbn=text.match(/97[89]\d{10}|\d{9}[\dX]/);
  if(isbn) document.getElementById('f020').innerText='$a '+isbn[0];
 }

 if(mode==='back'){
  document.getElementById('f520').innerText=
   '$a '+text.replace(/\n+/g,' ');
 }

 statusEl.innerText='Scan complete';
}

function invertName(n){
 const p=n.split(' ');
 return p.length>1 ? p.pop()+', '+p.join(' ') : n;
}
</script>

</body>
</html>
