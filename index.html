<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>TKU Western Cataloger v67.1</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.5/tesseract.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
#video-container{display:none;position:relative;border-radius:24px;overflow:hidden}
#scanner-line{position:absolute;top:0;width:100%;height:3px;background:#3b82f6;animation:scan 2s linear infinite}
@keyframes scan{0%{top:5%}50%{top:95%}100%{top:5%}}
.marc-field{font-family:Courier New,monospace;border:1px solid #e5e7eb;padding:8px;border-radius:10px;min-height:1.4em}
.locked{background:#f0fdf4;border-color:#22c55e}
.mode-active{outline:3px solid #000}
</style>
</head>

<body class="bg-slate-50">

<div class="max-w-2xl mx-auto p-4 space-y-4">

<header class="text-center">
<h1 class="text-2xl font-black">Western MARC v67.1</h1>
<p class="text-xs text-slate-400">Three-page Smart Cataloging</p>
</header>

<!-- MODE -->
<div class="grid grid-cols-3 gap-2">
<button id="btn-cover" class="mode-btn bg-blue-600 text-white py-3 rounded-xl" onclick="setMode('cover')">ğŸ“• å°é¢</button>
<button id="btn-verso" class="mode-btn bg-slate-600 text-white py-3 rounded-xl" onclick="setMode('verso')">ğŸ“„ ç‰ˆæ¬Šé </button>
<button id="btn-back"  class="mode-btn bg-emerald-600 text-white py-3 rounded-xl" onclick="setMode('back')">ğŸ“˜ å°åº•</button>
</div>

<div id="status" class="text-center text-xs text-slate-500">Initializingâ€¦</div>

<!-- CAMERA -->
<div id="video-container" class="aspect-[4/5] bg-black">
<video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
<div id="scanner-line"></div>
</div>

<button onclick="scanPage()" class="w-full bg-black text-white py-5 rounded-2xl font-black">
SCAN PAGE
</button>

<!-- MARC -->
<div class="bg-white rounded-3xl shadow p-6 space-y-2">
<div><b>020</b><div id="f-020" class="marc-field">$a </div></div>
<div><b>100</b><div id="f-100" class="marc-field">$a </div></div>
<div><b>245</b><div id="f-245" class="marc-field">$a  : $b  / $c </div></div>
<div><b>250</b><div id="f-250" class="marc-field">$a </div></div>
<div><b>264</b><div id="f-264" class="marc-field">$a  : $b , $c </div></div>
<div><b>700</b><div id="f-700" class="marc-field">$a </div></div>
<div><b>520</b><div id="f-520" class="marc-field text-xs">$a </div></div>
</div>

</div>

<canvas id="canvas" class="hidden"></canvas>

<script>
let worker;
let currentMode='cover';

let video,canvas,status;
let f020,f100,f245,f250,f264,f520,f700;

document.addEventListener('DOMContentLoaded',async()=>{
video=document.getElementById('video');
canvas=document.getElementById('canvas');
status=document.getElementById('status');
['020','100','245','250','264','520','700'].forEach(t=>{
window['f'+t]=document.getElementById('f-'+t);
});

worker=await Tesseract.createWorker('eng+fra+deu+spa+rus');
const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
video.srcObject=stream;
document.getElementById('video-container').style.display='block';
status.innerText='Ready';
setMode('cover');
});

function setMode(m){
currentMode=m;
['cover','verso','back'].forEach(x=>{
document.getElementById('btn-'+x)?.classList.remove('mode-active');
});
document.getElementById('btn-'+m).classList.add('mode-active');
status.innerText=`Mode: ${m}`;
}

function detectLang(t){
if(/[Ğ-Ğ¯Ğ°-ÑĞÑ‘]/.test(t))return'rus';
if(/[Ã¤Ã¶Ã¼ÃŸ]/i.test(t))return'deu';
if(/[Ã©Ã¨ÃªÃ Ã§]/i.test(t))return'fra';
if(/[Ã±Ã¡Ã©Ã­Ã³Ãº]/i.test(t))return'spa';
return'eng';
}

async function scanPage(){
status.innerText='Scanningâ€¦';
const ctx=canvas.getContext('2d');
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
ctx.filter='grayscale(1) contrast(1.5)';
ctx.drawImage(video,0,0);

const {data}=await worker.recognize(canvas);
const lang=detectLang(data.text);

if(currentMode==='cover') parseCover(data.text,lang);
if(currentMode==='verso') pa
