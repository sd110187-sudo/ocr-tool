<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Smart MARC - Dual API & Fuzzy OCR</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root { --primary: #7c3aed; --success: #22c55e; --fail: #ef4444; --bg: #f8fafc; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 60px; }
header { background: white; text-align: center; padding: 16px; font-weight: 800; font-size: 1.1rem; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }

/* Control Panel */
.controls { padding: 12px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; background: white; }
.mode-btn { padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #64748b; font-size: 13px; font-weight: 600; cursor: pointer; }
.mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

/* Scanner */
.scan-wrapper { padding: 16px; text-align: center; }
#scanBtn { width: 100%; padding: 16px; font-size: 18px; font-weight: bold; background: #0f172a; color: white; border: none; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
#scanBtn:disabled { background: #94a3b8; }
.status-bar { margin-top: 10px; font-size: 13px; color: #475569; min-height: 20px; font-weight: 500; }

/* MARC Form */
.card { background: white; margin: 12px 16px; padding: 16px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
.card-header { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
.badge { font-size: 10px; padding: 3px 8px; border-radius: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
.badge.api { background: #dbeafe; color: #1e40af; }
.badge.ocr { background: #fef9c3; color: #854d0e; }
.badge.none { background: #f1f5f9; color: #64748b; }

.field-row { margin-bottom: 10px; display: flex; align-items: center; }
.tag { width: 40px; font-family: monospace; font-weight: bold; color: #64748b; font-size: 14px; }
input, textarea { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: monospace; font-size: 14px; transition: all 0.2s; }
input:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
textarea { min-height: 80px; resize: vertical; }

.highlight-success { animation: flashGreen 1.5s; }
@keyframes flashGreen { 0% { background: #dcfce7; } 100% { background: white; } }

/* Debug Area */
details { margin: 0 16px; font-size: 12px; color: #64748b; }
#ocrDebug { white-space: pre-wrap; background: #f1f5f9; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; }
</style>
</head>
<body>

<header>MARC 21 æ™ºæ…§æƒæ</header>

<div class="controls">
    <button class="mode-btn active" onclick="setMode('copyright')">ç‰ˆæ¬Šé /æ¢ç¢¼</button>
    <button class="mode-btn" onclick="setMode('cover')">å°é¢</button>
    <button class="mode-btn" onclick="setMode('back')">å°åº•æ‘˜è¦</button>
</div>

<div class="scan-wrapper">
    <button id="scanBtn" onclick="document.getElementById('fileInput').click()">
        <span>ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ</span>
    </button>
    <div class="status-bar" id="status">æº–å‚™å°±ç·’</div>
    <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" onchange="processImage(this)">
</div>

<div class="card">
    <div class="card-header">
        <b>MARC è³‡æ–™</b>
        <span id="sourceBadge" class="badge none">ä¾†æº: ç„¡</span>
    </div>
    
    <div class="field-row"><span class="tag">020</span><input id="f020" placeholder="$a ISBN"></div>
    <div class="field-row"><span class="tag">100</span><input id="f100" placeholder="$a Author"></div>
    <div class="field-row"><span class="tag">245</span><input id="f245" placeholder="$a Title"></div>
    <div class="field-row"><span class="tag">250</span><input id="f250" placeholder="$a Edition"></div>
    <div class="field-row"><span class="tag">264</span><input id="f264" placeholder="$c Year"></div>
    <div class="field-row"><span class="tag">520</span><textarea id="f520" placeholder="$a Abstract"></textarea></div>
</div>

<details>
    <summary>æŸ¥çœ‹ OCR åŸå§‹æ–‡å­—</summary>
    <div id="ocrDebug">å°šæœªæƒæ</div>
</details>

<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
let worker;
let mode = 'copyright';

// 1. åˆå§‹åŒ– Tesseract
(async () => {
    setStatus('è¼‰å…¥ OCR æ ¸å¿ƒ...', true);
    worker = await Tesseract.createWorker('eng+fra+deu+spa+rus');
    setStatus('ç³»çµ±å°±ç·’');
})();

function setStatus(msg, loading = false) {
    const el = document.getElementById('status');
    el.textContent = msg;
    document.getElementById('scanBtn').disabled = loading;
    if(loading) el.textContent += ' â³';
}

function setMode(m) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    setStatus(`æ¨¡å¼: ${m === 'copyright' ? 'å„ªå…ˆæ‰¾ ISBN' : m === 'cover' ? 'æ ¡å°é¡Œå' : 'æŠ“å–æ‘˜è¦'}`);
}

async function processImage(input) {
    if (!input.files[0]) return;
    const file = input.files[0];
    
    setStatus('å½±åƒå„ªåŒ–è™•ç†...', true);
    
    // æ­¥é©Ÿ 1: å½±åƒå‰è™•ç† (è½‰ç°éš+äºŒå€¼åŒ–ï¼Œæ¥µå¤§æå‡ Tesseract æº–åº¦)
    const processedImg = await preprocessImage(file);
    
    setStatus('OCR è­˜åˆ¥ä¸­...', true);
    const { data: { text } } = await worker.recognize(processedImg);
    
    document.getElementById('ocrDebug').textContent = text;
    
    // æ­¥é©Ÿ 2: åŸ·è¡Œè³‡æ–™åˆ†æç­–ç•¥
    await analyzeData(text);
    
    input.value = ''; // é‡ç½®
}

// æ ¸å¿ƒé‚è¼¯ï¼šä¸‰å±¤é˜²ç¦¦ç³»çµ±
async function analyzeData(rawText) {
    setStatus('åˆ†ææ•¸æ“šä¸­...', true);
    
    // æ¸…æ´— OCR é›œè¨Š (å°‡ OCR å¸¸è¦‹éŒ¯èª¤å¦‚ 1SBN, 2O19 ä¿®æ­£)
    const cleanText = fuzzyClean(rawText);
    
    // ç­–ç•¥ A: å˜—è©¦æå– ISBN
    const isbn = extractISBN(cleanText);
    
    let apiFound = false;
    
    if (isbn) {
        setStatus(`åµæ¸¬åˆ° ISBN ${isbn}ï¼ŒæŸ¥è©¢è³‡æ–™åº«...`, true);
        
        // ç­–ç•¥ B1: Google Books API
        apiFound = await fetchGoogleBooks(isbn);
        
        // ç­–ç•¥ B2: å¦‚æœ Google å¤±æ•—ï¼Œå˜—è©¦ Open Library API
        if (!apiFound) {
            setStatus('Google ç„¡è³‡æ–™ï¼Œå˜—è©¦ Open Library...', true);
            apiFound = await fetchOpenLibrary(isbn);
        }
    }
    
    // ç­–ç•¥ C: å¦‚æœ API å…¨è»è¦†æ²’ï¼Œä½¿ç”¨å•Ÿç™¼å¼è¦å‰‡åˆ†æ OCR æ–‡å­—
    if (!apiFound) {
        setStatus('API ç„¡è³‡æ–™ï¼Œä½¿ç”¨ OCR æ™ºæ…§å¡«å…¥');
        document.getElementById('sourceBadge').textContent = "ä¾†æº: OCR è§£æ";
        document.getElementById('sourceBadge').className = "badge ocr";
        parseOCRFallback(cleanText);
    } else {
        setStatus('å®Œæˆ');
    }
}

// --- API æ¨¡çµ„ ---

async function fetchGoogleBooks(isbn) {
    try {
        const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
        const data = await res.json();
        if (data.totalItems > 0) {
            const info = data.items[0].volumeInfo;
            fillForm({
                source: 'Google API',
                f020: '$a ' + isbn,
                f100: info.authors ? `$a ${info.authors[0]}, $e author.` : '',
                f245: `$a ${info.title} ${info.subtitle ? ': $b ' + info.subtitle : ''}`,
                f264: `$c ${info.publishedDate?.substring(0,4) || ''} : $b ${info.publisher || ''}`,
                f520: info.description ? `$a ${info.description}` : ''
            });
            return true;
        }
    } catch(e) { console.error(e); }
    return false;
}

async function fetchOpenLibrary(isbn) {
    try {
        // Open Library API
        const key = `ISBN:${isbn}`;
        const res = await fetch(`https://openlibrary.org/api/books?bibkeys=${key}&jscmd=data&format=json`);
        const data = await res.json();
        
        if (data[key]) {
            const info = data[key];
            fillForm({
                source: 'Open Library',
                f020: '$a ' + isbn,
                f100: info.authors ? `$a ${info.authors[0].name}, $e author.` : '',
                f245: `$a ${info.title} ${info.subtitle ? ': $b ' + info.subtitle : ''}`,
                f264: `$c ${info.publish_date || ''} : $b ${info.publishers?.[0]?.name || ''}`,
                f520: '' // Open Library æ‘˜è¦é€šå¸¸è¼ƒå°‘
            });
            return true;
        }
    } catch(e) { console.error(e); }
    return false;
}

// --- å®¹éŒ¯èˆ‡å‚™æ´è§£ææ¨¡çµ„ (é—œéµéƒ¨åˆ†) ---

// 1. OCR ç³¾éŒ¯ï¼šä¿®æ­£å¸¸è¦‹çš„ OCR æ•¸å­—/å­—æ¯æ··æ·†
function fuzzyClean(text) {
    return text
        .replace(/\|/g, 'I') // æŠŠ | è®Šæˆ I
        .replace(/1SBN/gi, 'ISBN')
        .replace(/\bO(\d)/g, '0$1') // æŠŠ O123 è®Šæˆ 0123
        .replace(/\b(\d)O\b/g, '$10') // æŠŠ 199O è®Šæˆ 1990
        .replace(/ISBN.*?:?/gi, 'ISBN'); // çµ±ä¸€ ISBN å‰ç¶´
}

// 2. æš´åŠ›æŠ“å– ISBN (æ”¯æ´ 10 èˆ‡ 13 ç¢¼)
function extractISBN(text) {
    const match = text.match(/(97[89]\d{9}[\dxX])|(\d{9}[\dxX])/);
    return match ? match[0] : null;
}

// 3. æ™ºæ…§ fallback è§£æ (ç•¶æ²’æœ‰ API æ™‚)
function parseOCRFallback(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 2);
    
    // å¦‚æœæ˜¯ç‰ˆæ¬Šé ï¼Œå˜—è©¦æŠ“å¹´ä»½èˆ‡ ISBN
    if (mode === 'copyright') {
        const isbn = extractISBN(text);
        if(isbn && !getValue('f020')) fill('f020', '$a ' + isbn);

        // æ‰¾å¹´ä»½ (19xx æˆ– 20xx)
        const yearMatch = text.match(/\b(19|20)\d{2}\b/);
        if(yearMatch && !getValue('f264')) fill('f264', '$c ' + yearMatch[0]);
        
        // æ‰¾ç‰ˆæ¬¡ (Edition)
        const edMatch = text.match(/(\d+(st|nd|rd|th)\s+Ed)|(First|Second)\s+Ed/i);
        if(edMatch && !getValue('f250')) fill('f250', '$a ' + edMatch[0]);
    }
    
    // å¦‚æœæ˜¯å°é¢ï¼Œé€šå¸¸å­—é«”æœ€å¤§çš„æ˜¯æ›¸åï¼Œå…¶æ¬¡æ˜¯ä½œè€…
    if (mode === 'cover' && lines.length > 0) {
        if(!getValue('f245')) fill('f245', '$a ' + lines[0]); // å‡è¨­ç¬¬ä¸€è¡Œæ˜¯æ›¸å
        
        // å°‹æ‰¾åƒæ˜¯ä½œè€…çš„è¡Œ (é€šå¸¸æ²’æœ‰æ•¸å­—ï¼Œä¸”é•·åº¦é©ä¸­)
        for(let i=1; i<Math.min(lines.length, 5); i++) {
            const line = lines[i];
            if (!/\d/.test(line) && line.length < 30 && !getValue('f100')) {
                // ç°¡å–®æª¢æŸ¥æ˜¯å¦æœ‰ "by" é–‹é ­
                const name = line.replace(/^by\s+/i, '');
                fill('f100', '$a ' + name + ', $e author.');
            }
        }
    }

    // å¦‚æœæ˜¯å°åº•ï¼Œå…¨æ–‡å¡å…¥æ‘˜è¦
    if (mode === 'back' && !getValue('f520')) {
        // éæ¿¾æ‰ ISBN è¡Œ
        const summary = lines.filter(l => !l.includes('ISBN') && l.length > 20).join(' ');
        if(summary.length > 20) fill('f520', '$a ' + summary);
    }
}

// --- å½±åƒè™•ç†èˆ‡å·¥å…· ---

function preprocessImage(file) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
            const cvs = document.getElementById('hiddenCanvas');
            const ctx = cvs.getContext('2d');
            
            // ç¸®æ”¾åœ–ç‰‡ä»¥åŠ å¿« OCR é€Ÿåº¦ (å¯¬åº¦é™åˆ¶åœ¨ 1500px)
            const ratio = Math.min(1500 / img.width, 1);
            cvs.width = img.width * ratio;
            cvs.height = img.height * ratio;
            
            ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
            
            // è½‰ç°éšèˆ‡å¢åŠ å°æ¯”åº¦
            const idata = ctx.getImageData(0,0,cvs.width,cvs.height);
            const d = idata.data;
            for(let i=0; i<d.length; i+=4){
                const gray = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2]; // äº®åº¦å…¬å¼
                const val = gray > 140 ? 255 : 0; // äºŒå€¼åŒ–é–¾å€¼
                d[i] = d[i+1] = d[i+2] = val;
            }
            ctx.putImageData(idata,0,0);
            resolve(cvs.toDataURL('image/jpeg'));
        };
        img.src = URL.createObjectURL(file);
    });
}

function fillForm(data) {
    if(data.source) {
        const badge = document.getElementById('sourceBadge');
        badge.textContent = 'ä¾†æº: ' + data.source;
        badge.className = 'badge api';
    }
    for (let key in data) {
        if (key !== 'source' && data[key]) fill(key, data[key]);
    }
}

function fill(id, val) {
    const el = document.getElementById(id);
    if(el) {
        el.value = val;
        el.classList.add('highlight-success');
        setTimeout(()=>el.classList.remove('highlight-success'), 1500);
    }
}

function getValue(id) { return document.getElementById(id).value; }
</script>
</body>
</html>
